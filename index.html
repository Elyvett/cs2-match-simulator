<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Pro Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap');
        
        body { 
            font-family: 'Roboto Mono', monospace; 
            background-color: #0b0c10; 
            color: white;
            overflow: hidden;
            user-select: none;
        }
        
        canvas { 
            background-color: #12141a; 
            border: 1px solid #334155;
        }

        .hud-font { font-family: 'Oswald', sans-serif; }
        
        .radio-msg {
            animation: fadeIn 0.2s ease-out;
            padding: 4px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 11px;
            line-height: 1.2;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .scroll-hide::-webkit-scrollbar { display: none; }
        
        #victory-banner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            text-align: center;
            width: 100%;
            pointer-events: none;
        }

        .victory-text {
            font-family: 'Oswald', sans-serif;
            font-size: 80px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 10px;
            text-shadow: 0 0 30px rgba(0,0,0,0.8);
            animation: bannerIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes bannerIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen w-screen p-2 overflow-hidden bg-[#0b0c10]">

    <div id="victory-banner">
        <div id="victory-inner" class="victory-text"></div>
    </div>

    <div id="radio-window" class="fixed left-4 top-32 bottom-24 w-64 bg-black/80 border border-slate-700 rounded-lg flex flex-col z-50 transition-transform duration-300 hidden">
        <div class="flex border-b border-slate-700 bg-slate-900/50 rounded-t-lg">
            <button onclick="switchRadio('T')" id="tab-t" class="flex-1 py-2 text-[10px] font-bold text-orange-500 border-b-2 border-orange-500 uppercase tracking-tighter">T Radio</button>
            <button onclick="switchRadio('CT')" id="tab-ct" class="flex-1 py-2 text-[10px] font-bold text-slate-400 border-b-2 border-transparent uppercase tracking-tighter">CT Radio</button>
            <button onclick="toggleRadio()" class="p-2 text-slate-500 hover:text-white">âœ•</button>
        </div>
        <div id="radio-content" class="flex-1 overflow-y-auto p-2 scroll-hide space-y-1"></div>
        <div class="p-2 border-t border-slate-700 text-[9px] text-slate-500 text-center uppercase tracking-widest">Team Communication</div>
    </div>

    <div id="controls" class="fixed top-4 left-4 flex flex-col gap-2 z-50 hidden">
        <button id="btn-start" class="bg-orange-600 hover:bg-orange-500 text-white text-xs px-4 py-2 rounded font-bold transition-all uppercase shadow-lg">å¼€å§‹æ¨¡æ‹Ÿ</button>
        <button id="btn-speed" class="bg-slate-800 hover:bg-slate-700 text-white text-[10px] px-4 py-1.5 rounded border border-slate-600 transition-all">é€Ÿåº¦: 1x</button>
        <button onclick="toggleRadio()" class="bg-slate-800 hover:bg-slate-700 px-4 py-1.5 rounded text-[10px] border border-slate-600 text-white">æ— çº¿ç”µçª—</button>
    </div>

    <div class="fixed top-0 w-full flex justify-center pt-2 z-40 pointer-events-none">
        <div class="flex items-stretch bg-black/90 border border-slate-700/50 rounded-lg overflow-hidden shadow-2xl pointer-events-auto">
            <div class="bg-orange-600 px-6 flex flex-col items-center justify-center min-w-[120px]" id="t-score-box">
                <span class="text-[9px] font-bold opacity-80 uppercase tracking-widest" id="t-team-name">FURIA</span>
                <span id="score-t" class="text-3xl hud-font font-bold">0</span>
            </div>
            <div id="timer-container" class="px-8 py-1 flex flex-col items-center justify-center bg-slate-900 min-w-[140px] transition-colors duration-500">
                <span id="timer" class="text-2xl font-bold tabular-nums">01:55</span>
                <div id="defuse-bar-bg" class="hidden w-full h-1 bg-slate-700 mt-1 rounded-full overflow-hidden">
                    <div id="defuse-bar-fill" class="h-full bg-blue-400" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-blue-600 px-6 flex flex-col items-center justify-center min-w-[120px]" id="ct-score-box">
                <span class="text-[9px] font-bold opacity-80 uppercase tracking-widest" id="ct-team-name">VITALITY</span>
                <span id="score-ct" class="text-3xl hud-font font-bold">0</span>
            </div>
        </div>
    </div>

    <div id="kill-feed" class="fixed top-16 right-4 w-72 flex flex-col items-end z-50 pointer-events-none"></div>

    <div class="relative">
        <canvas id="gameCanvas" width="1000" height="700" class="rounded-lg shadow-2xl"></canvas>
    </div>

    <div id="defuse-label" class="fixed top-24 left-1/2 -translate-x-1/2 text-blue-400 font-bold text-sm hidden">æ­£åœ¨æ‹†é™¤ç‚¸å¼¹...</div>

    <div class="fixed bottom-4 w-full px-8 flex justify-between gap-8 pointer-events-none z-40 hidden">
        <div id="t-hud" class="flex-1 grid grid-cols-1 gap-2 max-w-[360px]"></div>
        <div id="ct-hud" class="flex-1 grid grid-cols-1 gap-2 max-w-[360px]"></div>
    </div>

    <!-- æ¸¸æˆå¼€å§‹ç”»é¢ -->
    <div id="start-screen" class="fixed inset-0 bg-black/90 flex items-center justify-center z-100">
        <div class="bg-slate-900 border border-slate-700 rounded-lg p-6 w-96">
            <h1 class="text-2xl font-bold text-center mb-6 text-white">CS2 æ¯”èµ›æ¨¡æ‹Ÿå™¨</h1>
            
            <div class="mb-6">
                <label class="block text-sm text-slate-400 mb-2">é€‰æ‹© T æ–¹é˜Ÿä¼</label>
                <select id="t-team-select" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white text-sm">
                    <option value="FURIA">FURIA</option>
                    <option value="Vitality">Vitality</option>
                    <option value="Falcons">Falcons</option>
                    <option value="MOUZ">MOUZ</option>
                    <option value="Spirit">Spirit</option>
                    <option value="FaZe">FaZe</option>
                    <option value="Natus Vincere">Natus Vincere</option>
                    <option value="G2">G2</option>
                    <option value="The MongolZ">The MongolZ</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm text-slate-400 mb-2">é€‰æ‹© CT æ–¹é˜Ÿä¼</label>
                <select id="ct-team-select" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white text-sm">
                    <option value="Vitality">Vitality</option>
                    <option value="FURIA">FURIA</option>
                    <option value="Falcons">Falcons</option>
                    <option value="MOUZ">MOUZ</option>
                    <option value="Spirit">Spirit</option>
                    <option value="FaZe">FaZe</option>
                    <option value="Natus Vincere">Natus Vincere</option>
                    <option value="G2">G2</option>
                    <option value="The MongolZ">The MongolZ</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            
            <!-- è‡ªå®šä¹‰é˜Ÿä¼é€‰é¡¹ -->
            <div id="custom-options" class="mb-6 hidden">
                <h3 class="text-sm font-bold text-white mb-3">è‡ªå®šä¹‰é˜Ÿä¼</h3>
                
                <div class="mb-3">
                    <label class="block text-xs text-slate-400 mb-1">T æ–¹é˜Ÿä¼å</label>
                    <input type="text" id="t-team-name" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-sm" placeholder="è¾“å…¥é˜Ÿä¼å">
                </div>
                
                <div class="mb-3">
                    <label class="block text-xs text-slate-400 mb-1">CT æ–¹é˜Ÿä¼å</label>
                    <input type="text" id="ct-team-name-input" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-sm" placeholder="è¾“å…¥é˜Ÿä¼å">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <h4 class="text-xs font-bold text-white mb-2">T æ–¹é€‰æ‰‹</h4>
                        <input type="text" id="t-player-1" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-xs mb-1" placeholder="ç‹™å‡»æ‰‹">
                        <input type="text" id="t-player-2" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-xs mb-1" placeholder="æŒ‡æŒ¥">
                        <input type="text" id="t-player-3" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-xs mb-1" placeholder="æ­¥æª">
                        <input type="text" id="t-player-4" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-xs mb-1" placeholder="æ­¥æª">
                        <input type="text" id="t-player-5" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-xs" placeholder="æ­¥æª">
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-white mb-2">CT æ–¹é€‰æ‰‹</h4>
                        <input type="text" id="ct-player-1" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-xs mb-1" placeholder="ç‹™å‡»æ‰‹">
                        <input type="text" id="ct-player-2" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-xs mb-1" placeholder="æŒ‡æŒ¥">
                        <input type="text" id="ct-player-3" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-xs mb-1" placeholder="æ­¥æª">
                        <input type="text" id="ct-player-4" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-xs mb-1" placeholder="æ­¥æª">
                        <input type="text" id="ct-player-5" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white text-xs" placeholder="æ­¥æª">
                    </div>
                </div>
            </div>
            
            <button id="btn-start-game" class="w-full bg-orange-600 hover:bg-orange-500 text-white py-2 rounded font-bold transition-all uppercase shadow-lg">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>

    <div class="fixed bottom-4 w-full px-8 flex justify-between gap-8 pointer-events-none z-40">
        <div id="t-hud" class="flex-1 grid grid-cols-1 gap-2 max-w-[360px]"></div>
        <div id="ct-hud" class="flex-1 grid grid-cols-1 gap-2 max-w-[360px]"></div>
    </div>

    <script>
        // é¢„è®¾é˜Ÿä¼æ•°æ®
        const TEAMS = {
            'Vitality': { players: ['ZywOo', 'apEX', 'ropz', 'flameZ', 'mezii'], roles: ['AWP', 'Rifle', 'Rifle', 'Rifle', 'Rifle'] },
            'FURIA': { players: ['molodoy', 'FalleN', 'YEKINDAR', 'yuurih', 'KSCERATO'], roles: ['AWP', 'Rifle', 'Rifle', 'Rifle', 'Rifle'] },
            'Falcons': { players: ['m0NESY', 'kyxsan', 'NiKo', 'TeSeS', 'kyousuke'], roles: ['AWP', 'Rifle', 'Rifle', 'Rifle', 'Rifle'] },
            'MOUZ': { players: ['torzsi', 'Brollan', 'Spinx', 'Jimpphat', 'xertioN'], roles: ['AWP', 'Rifle', 'Rifle', 'Rifle', 'Rifle'] },
            'Spirit': { players: ['sh1ro', 'magixx', 'tN1R', 'zont1x', 'donk'], roles: ['AWP', 'Rifle', 'Rifle', 'Rifle', 'Rifle'] },
            'FaZe': { players: ['broky', 'karrigan', 'frozen', 'Twistzz', 'jcobbb'], roles: ['AWP', 'Rifle', 'Rifle', 'Rifle', 'Rifle'] },
            'Natus Vincere': { players: ['w0nderful', 'Aleksib', 'iM', 'b1t', 'makazze'], roles: ['AWP', 'Rifle', 'Rifle', 'Rifle', 'Rifle'] },
            'G2': { players: ['SunPayus', 'huNter-', 'malbsMd', 'HeavyGod', 'MATYS'], roles: ['AWP', 'Rifle', 'Rifle', 'Rifle', 'Rifle'] },
            'The MongolZ': { players: ['910', 'blitz', 'Techno', 'mzinho', 'cobrazera'], roles: ['AWP', 'Rifle', 'Rifle', 'Rifle', 'Rifle'] }
        };
        
        // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰é€‰é¡¹
        document.getElementById('t-team-select').addEventListener('change', function() {
            const customOptions = document.getElementById('custom-options');
            const tCustom = this.value === 'custom';
            const ctCustom = document.getElementById('ct-team-select').value === 'custom';
            customOptions.style.display = (tCustom || ctCustom) ? 'block' : 'none';
        });
        
        document.getElementById('ct-team-select').addEventListener('change', function() {
            const customOptions = document.getElementById('custom-options');
            const ctCustom = this.value === 'custom';
            const tCustom = document.getElementById('t-team-select').value === 'custom';
            customOptions.style.display = (tCustom || ctCustom) ? 'block' : 'none';
        });
        
        // å¼€å§‹æ¸¸æˆæŒ‰é’®
        document.getElementById('btn-start-game').addEventListener('click', function() {
            const tTeam = document.getElementById('t-team-select').value;
            const ctTeam = document.getElementById('ct-team-select').value;
            
            // éšè—å¼€å§‹ç”»é¢
            document.getElementById('start-screen').style.display = 'none';
            
            // æ˜¾ç¤ºä¹‹å‰éšè—çš„UIå…ƒç´ 
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('radio-window').style.display = 'flex';
            document.querySelector('.fixed.bottom-4').style.display = 'flex';
            
            // åˆå§‹åŒ–æ¸¸æˆ
            initGame(tTeam, ctTeam);
        });
        
        function initGame(tTeam, ctTeam) {
            let T_NAMES = [];
            let CT_NAMES = [];
            
            // è®¾ç½® T æ–¹é˜Ÿä¼
            if (tTeam === 'custom') {
                const teamName = document.getElementById('t-team-name').value || 'Custom T';
                T_NAMES = [
                    {n: document.getElementById('t-player-1').value || 'Sniper', r: 'AWP'},
                    {n: document.getElementById('t-player-2').value || 'IGL', r: 'Rifle'},
                    {n: document.getElementById('t-player-3').value || 'Rifle1', r: 'Rifle'},
                    {n: document.getElementById('t-player-4').value || 'Rifle2', r: 'Rifle'},
                    {n: document.getElementById('t-player-5').value || 'Rifle3', r: 'Rifle'}
                ];
                document.getElementById('t-team-name').innerText = teamName;
            } else {
                const team = TEAMS[tTeam];
                T_NAMES = team.players.map((player, index) => ({n: player, r: team.roles[index]}));
                document.getElementById('t-team-name').innerText = tTeam;
            }
            
            // è®¾ç½® CT æ–¹é˜Ÿä¼
            if (ctTeam === 'custom') {
                const teamName = document.getElementById('ct-team-name-input').value || 'Custom CT';
                CT_NAMES = [
                    {n: document.getElementById('ct-player-1').value || 'Sniper', r: 'AWP'},
                    {n: document.getElementById('ct-player-2').value || 'IGL', r: 'Rifle'},
                    {n: document.getElementById('ct-player-3').value || 'Rifle1', r: 'Rifle'},
                    {n: document.getElementById('ct-player-4').value || 'Rifle2', r: 'Rifle'},
                    {n: document.getElementById('ct-player-5').value || 'Rifle3', r: 'Rifle'}
                ];
                document.getElementById('ct-team-name').innerText = teamName;
            } else {
                const team = TEAMS[ctTeam];
                CT_NAMES = team.players.map((player, index) => ({n: player, r: team.roles[index]}));
                document.getElementById('ct-team-name').innerText = ctTeam;
            }
            
            // åˆå§‹åŒ–å›åˆ
            initRoundWithTeams(T_NAMES, CT_NAMES);
        }
        
        function initRoundWithTeams(tNames, ctNames) {
            // è¿™é‡Œå°†åœ¨åŸæœ‰initRoundå‡½æ•°ä¸­ä½¿ç”¨tNameså’ŒctNames
            window.T_NAMES = tNames;
            window.CT_NAMES = ctNames;
            initRound();
        }
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const MAP_NODES = {
            'bç‚¹': { x: 100, y: 150, links: ['b2', 'ç‹—æ´', 'bé—¨'], type: 'site', isOnFire: false },
            'b2': { x: 100, y: 350, links: ['bç‚¹', 'åèŠ±å›­', 'b1'], isOnFire: false },
            'ç‹—æ´': { x: 250, y: 100, links: ['bç‚¹', 'æ²™åœ°'], isOnFire: false },
            'bé—¨': { x: 250, y: 220, links: ['bç‚¹', 'æ²™åœ°'], isOnFire: false },
            'æ²™åœ°': { x: 450, y: 180, links: ['ç‹—æ´', 'bé—¨', 'ä¸­é—¨', 'è­¦å®¶'], isOnFire: false },
            'åèŠ±å›­': { x: 100, y: 550, links: ['b2', 'åŒªå®¶', 'åŒªå£'], isOnFire: false },
            'b1': { x: 250, y: 350, links: ['b2', 'ä¸­è·¯'], isOnFire: false },
            'ä¸­é—¨': { x: 450, y: 300, links: ['æ²™åœ°', 'ä¸­è·¯'], isOnFire: false },
            'ä¸­è·¯': { x: 450, y: 450, links: ['b1', 'ä¸­é—¨', 'ä¸­è¿œ', 'æš—é“'], isOnFire: false },
            'ä¸­è¿œ': { x: 520, y: 550, links: ['ä¸­è·¯', 'aå°ä¸‹', 'æš—é“', 'åŒªå£'], isOnFire: false },
            'è­¦å®¶': { x: 650, y: 250, links: ['æ²™åœ°', 'aå°ä¸Š', 'aå¤§'], type: 'spawn', isOnFire: false },
            'aå°ä¸‹': { x: 650, y: 450, links: ['ä¸­è¿œ', 'aå°ä¸Š'], isOnFire: false },
            'aå°ä¸Š': { x: 650, y: 350, links: ['aå°ä¸‹', 'è­¦å®¶', 'aç‚¹'], isOnFire: false },
            'æš—é“': { x: 350, y: 550, links: ['åŒªå®¶', 'ä¸­è¿œ', 'ä¸­è·¯'], isOnFire: false },
            'åŒªå£': { x: 600, y: 600, links: ['ä¸­è¿œ', 'aé—¨', 'åèŠ±å›­', 'åŒªå®¶'], isOnFire: false },
            'åŒªå®¶': { x: 350, y: 650, links: ['åèŠ±å›­', 'æš—é“', 'åŒªå£'], type: 'spawn', isOnFire: false },
            'aé—¨': { x: 750, y: 600, links: ['åŒªå£', 'aé—¨å¤–'], isOnFire: false },
            'aé—¨å¤–': { x: 880, y: 600, links: ['aé—¨', 'aå¤§'], isOnFire: false },
            'aå¤§': { x: 880, y: 350, links: ['aé—¨å¤–', 'è­¦å®¶', 'aç‚¹'], isOnFire: false },
            'aç‚¹': { x: 800, y: 150, links: ['aå°ä¸Š', 'aå¤§'], type: 'site', isOnFire: false }
        };

        const WEAPONS = {
            'AK-47': { cd: 110, ammo: 30, reload: 2500, price: 2700, isMain: true, damage: 35, headDamage: 70 },
            'M4A1-S': { cd: 100, ammo: 20, reload: 2500, price: 2900, isMain: true, damage: 30, headDamage: 60 },
            'Glock-18': { cd: 300, ammo: 20, reload: 2000, price: 200, isMain: false, damage: 30, headDamage: 90 },
            'USP-S': { cd: 350, ammo: 12, reload: 2000, price: 200, isMain: false, damage: 30, headDamage: 100 },
            'FN57': { cd: 300, ammo: 20, reload: 2000, price: 500, isMain: false, damage: 30, headDamage: 200,è§†é‡ç¼©çŸ­: true }, // CTæ‰‹æª
            'Tec-9': { cd: 200, ammo: 18, reload: 2000, price: 500, isMain: false, damage: 40, headDamage: 200,è§†é‡ç¼©çŸ­: true }, // Tæ‰‹æª
            'Deagle': { cd: 500, ammo: 7, reload: 2000, price: 700, isMain: false, damage: 60, headDamage: 200 }, // é€šç”¨æ‰‹æª
            'AWP': { cd: 1500, ammo: 5, reload: 4000, price: 4750, isMain: true, damage: 100, headDamage: 200 },
            'MAC-10': { cd: 150, ammo: 30, reload: 2500, price: 1050, isMain: true, damage: 20, headDamage: 40 }, // Tæ–¹å†²é”‹æª
            'MP9': { cd: 100, ammo: 30, reload: 2500, price: 1200, isMain: true, damage: 20, headDamage: 50 } // CTæ–¹å†²é”‹æª
        };

        // æ­¦å™¨éŸ³æ•ˆç®¡ç†
        const WeaponSounds = {
            sounds: {},
            
            init: function() {
                // é¢„åŠ è½½æ­¦å™¨éŸ³æ•ˆ
                this.sounds['AK-47'] = this.createAudio('sounds/ak47.mp3');
                this.sounds['M4A1-S'] = this.createAudio('sounds/m4a1.mp3');
                this.sounds['Glock-18'] = this.createAudio('sounds/glock.mp3');
                this.sounds['USP-S'] = this.createAudio('sounds/usp.mp3');
                this.sounds['FN57'] = this.createAudio('sounds/fn57.wav');
                this.sounds['Tec-9'] = this.createAudio('sounds/tec9.wav');
                this.sounds['Deagle'] = this.createAudio('sounds/deagle.wav');
                this.sounds['AWP'] = this.createAudio('sounds/awp.mp3');
                this.sounds['MAC-10'] = this.createAudio('sounds/mac10.mp3');
                this.sounds['MP9'] = this.createAudio('sounds/mp9.mp3');
                
                // é¢„åŠ è½½å…¶ä»–éŸ³æ•ˆ
                this.sounds['t_win'] = this.createAudio('sounds/terwin.wav');
                this.sounds['ct_win'] = this.createAudio('sounds/ctwin.wav');
                this.sounds['bomb_plant'] = this.createAudio('sounds/bombpl.wav');
                this.sounds['bomb_defuse'] = this.createAudio('sounds/bombdef.wav');
                this.sounds['flash_explode'] = this.createAudio('sounds/flashbang_explode2_distant.wav');
                this.sounds['smoke_explode'] = this.createAudio('sounds/sg_explode_distant.wav');
                this.sounds['grenade_explode'] = this.createAudio('sounds/nade_explode.wav');
                
                // é¢„åŠ è½½ç‚¸å¼¹ç›¸å…³éŸ³æ•ˆ
                this.sounds['c4_beep'] = this.createAudio('sounds/c4_beep2.wav');
                this.sounds['c4_initiate'] = this.createAudio('sounds/c4_initiate.wav');
                this.sounds['c4_disarmstart'] = this.createAudio('sounds/c4_disarmstart.wav');
                
                // é¢„åŠ è½½å…¶ä»–éŸ³æ•ˆ
                this.sounds['round_start'] = this.createAudio('sounds/tstart.mp3');
                this.sounds['molotov_explode'] = this.createAudio('sounds/molotov_detonate_1_distant.wav');
                this.sounds['hegrenade_explode'] = this.createAudio('sounds/hegrenade.wav');
                this.sounds['c4_explode'] = this.createAudio('sounds/explode4.wav');
                this.sounds['reload'] = this.createAudio('sounds/reload.mp3');
            },
            
            createAudio: function(url) {
                const audio = new Audio(url);
                audio.preload = 'auto';
                return audio;
            },
            
            play: function(sound) {
                if (this.sounds[sound]) {
                    const audio = this.sounds[sound].cloneNode();
                    // æ‰‹é›·éŸ³é‡å˜ä¸ºåŸæ¥çš„ä¸€åŠ
                    if (sound === 'hegrenade_explode') {
                        audio.volume = 0.05; // éŸ³é‡ä¿®æ”¹ä¸º0.05
                    } else {
                        audio.volume = 0.1; // å…¶ä»–éŸ³æ•ˆéŸ³é‡ä¿æŒ0.1
                    }
                    audio.play().catch(e => console.log('Audio play failed:', e));
                }
            }
        };

        // åˆå§‹åŒ–éŸ³æ•ˆ
        WeaponSounds.init();

        const UTILITY_PRICES = { smoke: 300, fire: 400, flash: 200, nade: 300 };

        function findPath(start, end) {
            let queue = [[start]], visited = new Set([start]);
            while (queue.length > 0) {
                let path = queue.shift();
                let last = path[path.length - 1];
                if (last === end) return path;
                for (let neighbor of MAP_NODES[last].links) {
                    if (!visited.has(neighbor)) { visited.add(neighbor); queue.push([...path, neighbor]); }
                }
            }
            return [start];
        }

        let state = {
            running: false, speed: 1, time: 115, score: {t:0, ct:0}, round: 1,
            players: [], tracers: [], smokes: [], flashes: [], molotovs: [], grenades: [], droppedWeapons: [],
            bomb: { state: 'idle', carrier: null, x: 0, y: 0, node: null, time: 40, defuser: null, defuseProgress: 0, planter: null },
            lastTick: 0, radioView: 'T', radioHistory: { T: [], CT: [] },
            isRoundEnded: false,
            lastTacticCheck: 0,
            lastSmokeCheck: 0,
            lastRetakeFlashCheck: 0,
            consecutiveLosses: { T: 0, CT: 0 },
            isSwapped: false,
            winTarget: 13,
            hasReleasedStartMolotov: false, // æ ‡è®°æ˜¯å¦å·²ç»å‘å¸ƒäº†å¼€å±€ç‡ƒçƒ§ç“¶æŒ‡ä»¤
            hasReleasedCTB2Fire: false, // æ ‡è®°æ˜¯å¦å·²ç»å‘å¸ƒäº†CTå¼€å±€b2ç«æŒ‡ä»¤
            hasReleasedStartNade: false, // æ ‡è®°æ˜¯å¦å·²ç»å‘å¸ƒäº†Tæ–¹å¼€å±€ä¸¢é›·æŒ‡ä»¤
            lastAttackMolotovTime: { a: 0, b: 0 }, // è¿›æ”»a/bç‚¹æ‰”ç«æŒ‡ä»¤çš„å†·å´æ—¶é—´
            lastNadeTime: 0 // ä¸Šæ¬¡æŠ•æ·æ‰‹é›·çš„æ—¶é—´
        };

        class DroppedWeapon {
            constructor(name, x, y) {
                this.name = name;
                this.x = x;
                this.y = y;
            }
            draw(ctx) {
                ctx.fillStyle = 'black';
                const textWidth = ctx.measureText(this.name).width + 10;
                ctx.fillRect(this.x - textWidth/2, this.y - 8, textWidth, 16);
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 1;
                ctx.strokeRect(this.x - textWidth/2, this.y - 8, textWidth, 16);
                ctx.fillStyle = 'white';
                ctx.font = '10px Roboto Mono';
                ctx.textAlign = 'center';
                ctx.fillText(this.name, this.x, this.y + 4);
            }
        }

        class Smoke {
            constructor(team, startX, startY, targetNode, instant = false) {
                this.team = team;
                this.startX = startX;
                this.startY = startY;
                const target = MAP_NODES[targetNode];
                this.targetX = target.x; this.targetY = target.y;
                this.targetNode = targetNode;
                this.isFlying = !instant;
                this.progress = instant ? 1 : 0;
                this.duration = 18; 
                this.life = this.duration;
                this.radius = 45;
                this.baseColor = team === 'CT' ? 'rgba(100, 150, 255, 0.6)' : 'rgba(255, 150, 50, 0.6)';
                this.color = this.baseColor;
                this.seedX = Math.random() * 100;
                this.seedY = Math.random() * 100;
                this.grenadeEffect = 0; // æ‰‹é›·å½±å“æ—¶é—´ï¼Œ0è¡¨ç¤ºæ— å½±å“
                this.grenadeEffectMax = 3; // æ‰‹é›·å½±å“æœ€å¤§æ—¶é—´
                
                // å¦‚æœæ˜¯ç«‹å³çˆ†å¼€ï¼Œç›´æ¥è®¾ç½®åˆ°ç›®æ ‡ä½ç½®å¹¶æ’­æ”¾éŸ³æ•ˆ
                if (instant) {
                    this.x = this.targetX;
                    this.y = this.targetY;
                    WeaponSounds.play('smoke_explode');
                } else {
                    this.x = startX;
                    this.y = startY;
                }
            }
            update(dt) {
                if (this.isFlying) {
                    this.progress += dt * 0.45;
                    if (this.progress >= 1) {
                        this.progress = 1;
                        this.isFlying = false;
                        this.x = this.targetX;
                        this.y = this.targetY;
                        WeaponSounds.play('smoke_explode');
                    } else {
                        this.x = this.startX + (this.targetX - this.startX) * this.progress;
                        this.y = this.startY + (this.targetY - this.startY) * this.progress;
                    }
                } else {
                    this.life -= dt;
                    
                    // å¤„ç†æ‰‹é›·å½±å“
                    if (this.grenadeEffect > 0) {
                        this.grenadeEffect -= dt;
                        if (this.grenadeEffect < 0) this.grenadeEffect = 0;
                        
                        // è®¡ç®—é€æ˜åº¦ï¼šå…ˆå˜å¤§åå˜å°
                        const normalizedTime = this.grenadeEffect / this.grenadeEffectMax;
                        let alpha;
                        if (normalizedTime > 0.5) {
                            // å‰1.5ç§’é€æ˜åº¦å˜å¤§
                            alpha = 0.6 + (1.0 - 0.6) * (1 - (normalizedTime - 0.5) * 2);
                        } else {
                            // å1.5ç§’é€æ˜åº¦å˜å°
                            alpha = 0.6 + (1.0 - 0.6) * (normalizedTime * 2);
                        }
                        
                        // æ›´æ–°é¢œè‰²é€æ˜åº¦
                        const colorMatch = this.baseColor.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*(.*?)\)/);
                        if (colorMatch) {
                            const r = colorMatch[1];
                            const g = colorMatch[2];
                            const b = colorMatch[3];
                            this.color = `rgba(${r}, ${g}, ${b}, ${alpha})`;
                        }
                    } else if (this.color !== this.baseColor) {
                        // æ¢å¤åŸºç¡€é¢œè‰²
                        this.color = this.baseColor;
                    }
                }
            }
            draw(ctx) {
                if (this.isFlying) {
                    ctx.fillStyle = this.color;
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    const pulse = 1 + Math.sin(this.progress * Math.PI) * 0.5;
                    ctx.fillRect(-3 * pulse, -3 * pulse, 6 * pulse, 6 * pulse);
                    ctx.restore();
                } else {
                    ctx.save();
                    ctx.fillStyle = this.color;
                    const time = Date.now() * 0.001; 
                    const range = 6;         
                    const offsetX1 = Math.sin(time * 1.2 + this.seedX) * range;
                    const offsetY1 = Math.cos(time * 1.2 + this.seedY) * range;
                    ctx.beginPath();
                    ctx.arc(this.x + offsetX1, this.y + offsetY1, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            }
        }

        class Flash {
            constructor(team, startX, startY, targetNode) {
                this.team = team;
                this.startX = startX; this.startY = startY;
                this.x = startX; this.y = startY;
                const target = MAP_NODES[targetNode];
                this.targetX = target.x; this.targetY = target.y;
                this.targetNode = targetNode;
                this.isFlying = true;
                this.progress = 0;
                this.exploded = false;
                this.flashLife = 0; 
            }
            update(dt) {
                if (this.isFlying) {
                    this.progress += dt * 0.8; 
                    if (this.progress >= 1) {
                        this.progress = 1;
                        this.isFlying = false;
                        this.explode();
                    }
                    this.x = this.startX + (this.targetX - this.startX) * this.progress;
                    this.y = this.startY + (this.targetY - this.startY) * this.progress;
                } else if (this.exploded) {
                    this.flashLife -= dt * 2;
                }
            }
            explode() {
                this.exploded = true;
                this.flashLife = 1.0;
                WeaponSounds.play('flash_explode');
                state.players.forEach(p => {
                    if (p.isAlive) {
                        const dist = Math.sqrt((p.x - this.x)**2 + (p.y - this.y)**2);
                        if (dist < 150) p.blind(4); 
                    }
                });
            
            // ç»˜åˆ¶æ‰‹é›·å’Œçˆ†ç‚¸ç‰¹æ•ˆåœ¨æœ€é¡¶å±‚
            if (state.grenades) {
                state.grenades.forEach(g => g.draw(ctx));
            }
        }
            draw(ctx) {
                if (this.isFlying) {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(this.x - 4, this.y - 2, 8, 4);
                } else if (this.exploded && this.flashLife > 0) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${this.flashLife})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 100 * (1.5 - this.flashLife), 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        class Molotov {
            constructor(team, thrower, startX, startY, targetNode) {
                this.team = team;
                this.thrower = thrower;
                this.startX = startX; this.startY = startY;
                this.x = startX; this.y = startY;
                const target = MAP_NODES[targetNode];
                this.targetX = target.x; this.targetY = target.y;
                this.targetNode = targetNode;
                this.isFlying = true;
                this.progress = 0;
                this.exploded = false;
                this.life = 5; // ç‡ƒçƒ§ç“¶æŒç»­5ç§’
                this.lastDamage = 0; // ä¸Šæ¬¡é€ æˆä¼¤å®³çš„æ—¶é—´
                this.radius = 60; // ç‡ƒçƒ§èŒƒå›´
            }
            update(dt) {
                if (this.isFlying) {
                    this.progress += dt * 0.6; // ç‡ƒçƒ§ç“¶é£è¡Œé€Ÿåº¦
                    if (this.progress >= 1) {
                        this.progress = 1;
                        this.isFlying = false;
                        this.explode();
                    }
                    this.x = this.startX + (this.targetX - this.startX) * this.progress;
                    this.y = this.startY + (this.targetY - this.startY) * this.progress;
                } else if (this.exploded) {
                    // æ£€æŸ¥æ˜¯å¦åœ¨çƒŸé›¾ä¸­ï¼Œå¦‚æœåœ¨çƒŸé›¾ä¸­ä¼šè¢«ç†„ç­
                    const inSmoke = state.smokes.some(s => {
                        if (s.isFlying) return false;
                        const dist = Math.sqrt((this.x - s.x)**2 + (this.y - s.y)**2);
                        return dist < s.radius;
                    });
                    
                    if (inSmoke) {
                        this.life = -1; // ç«‹å³ç†„ç­
                        // å°†ç›®æ ‡åŒºå—æ ‡è®°ä¸ºéç€ç«çŠ¶æ€
                        if (this.targetNode && MAP_NODES[this.targetNode]) {
                            MAP_NODES[this.targetNode].isOnFire = false;
                        }
                        return;
                    }
                    
                    this.life -= dt;
                    
                    // æ¯0.1ç§’é€ æˆä¼¤å®³
                    this.lastDamage += dt;
                    if (this.lastDamage >= 0.1) {
                        this.lastDamage = 0;
                        this.dealDamage();
                    }
                    
                    // å½“ç‡ƒçƒ§ç“¶ç†„ç­æ—¶ï¼Œå°†å¯¹åº”åŒºå—çš„ç€ç«çŠ¶æ€è®¾ç½®ä¸ºfalse
                    if (this.life <= 0 && this.exploded) {
                        if (this.targetNode && MAP_NODES[this.targetNode]) {
                            MAP_NODES[this.targetNode].isOnFire = false;
                        }
                    }
                }
            }
            explode() {
                this.exploded = true;
                WeaponSounds.play('molotov_explode');
                
                // å°†ç›®æ ‡åŒºå—æ ‡è®°ä¸ºç€ç«çŠ¶æ€
                if (this.targetNode && MAP_NODES[this.targetNode]) {
                    MAP_NODES[this.targetNode].isOnFire = true;
                }
            }
            dealDamage() {
                state.players.forEach(p => {
                    if (p.isAlive) {
                        const dist = Math.sqrt((p.x - this.x)**2 + (p.y - this.y)**2);
                        if (dist < this.radius) {
                            p.hp -= 2; // ç‡ƒçƒ§ç“¶ä¼¤å®³æé«˜åˆ°åŸæ¥çš„ä¸¤å€
                            p.hitFlash = 1.0;
                            p.isOnFire = true; // æ ‡è®°ç©å®¶æ­£åœ¨å—åˆ°ç‡ƒçƒ§ä¼¤å®³
                            p.lastFireCheck = 0; // é‡ç½®ç‡ƒçƒ§ä¼¤å®³æ£€æŸ¥è®¡æ—¶å™¨
                            
                            // æ£€æŸ¥æ˜¯å¦æ­»äº¡
                            if (p.hp <= 0) {
                                p.hp = 0;
                                p.isAlive = false;
                                p.deaths++;
                                
                                if (WEAPONS[p.weapon].isMain) {
                                    state.droppedWeapons.push(new DroppedWeapon(p.weapon, p.x, p.y));
                                }

                                if (p.isPlanting) { 
                                    state.bomb.state = 'idle'; 
                                    state.bomb.carrier = null; 
                                    state.bomb.x = p.x; 
                                    state.bomb.y = p.y; 
                                    state.bomb.node = p.posNode; 
                                    p.hasBomb = false; 
                                }
                                if (p.hasBomb) { 
                                    state.bomb.carrier = null; 
                                    state.bomb.x = p.x; 
                                    state.bomb.y = p.y; 
                                    state.bomb.node = p.posNode; 
                                    p.hasBomb = false; 
                                }
                                if (state.bomb.defuser === p) { 
                                    state.bomb.defuser = null; 
                                    state.bomb.defuseProgress = 0; 
                                    document.getElementById('defuse-bar-bg').classList.add('hidden'); 
                                }
                                
                                // æ·»åŠ ç‡ƒçƒ§ç“¶å‡»æ€åé¦ˆ
                                if (this.thrower === p) {
                                    // è¸©åˆ°è‡ªå·±ä¸¢çš„ç«
                                    addKillFeed(p, p, 'â˜ ï¸', false);
                                } else {
                                    // è¸©åˆ°æ•Œäººæˆ–é˜Ÿå‹ä¸¢çš„ç«
                                    if (this.thrower) {
                                        addKillFeed(this.thrower, p, 'ğŸ”¥', false);
                                    } else {
                                        // å¦‚æœæ‰¾ä¸åˆ°æŠ•æ·è€…ï¼Œæ˜¾ç¤ºç¯å¢ƒä¼¤å®³
                                        addKillFeed({ name: 'ğŸ”¥', team: this.team }, p, 'ğŸ”¥', false);
                                    }
                                }
                                checkRoundEnd();
                                return; // è·³è¿‡åç»­é€»è¾‘
                            }
                            
                            // æ–°çš„è¸©ç«è¡Œä¸ºé€»è¾‘
                            if (!p.isHitReacting && !p.isEscapingFire) {
                                p.isHitReacting = true;
                                p.isEscapingFire = true; // æ ‡è®°ç©å®¶æ­£åœ¨æ‰§è¡Œè¸©ç«é€ƒç¦»ä»»åŠ¡
                                
                                // ç§»åŠ¨åˆ°å½“å‰èŠ‚ç‚¹linksçš„ç¬¬ä¸€ä¸ªç›®æ ‡
                                const currentNode = p.posNode;
                                const currentMapNode = MAP_NODES[currentNode];
                                
                                if (currentMapNode && currentMapNode.links && currentMapNode.links.length > 0) {
                                    // ç›´æ¥é€‰æ‹©ç¬¬ä¸€ä¸ªç›¸é‚»èŠ‚ç‚¹ä½œä¸ºé€ƒç¦»ç›®æ ‡
                                    const firstExit = currentMapNode.links[0];
                                    p.destination = firstExit;
                                    p.path = findPath(currentNode, firstExit);
                                    p.pathIdx = 0;
                                    p.broadcastRadio(`æ­£åœ¨é€ƒç¦»ç«ç„°ï¼Œå‰å¾€ ${firstExit}ï¼`);
                                    // å½“ç©å®¶åˆ°è¾¾ç›®æ ‡åœ°ç‚¹æ—¶ï¼Œä¼šåœ¨moveAlongPathä¸­è‡ªåŠ¨é‡ç½®isEscapingFire
                                }
                            }
                        }
                    }
                });
            }
            draw(ctx) {
                if (this.isFlying) {
                    ctx.fillStyle = 'red';
                    ctx.fillRect(this.x - 3, this.y - 3, 6, 6);
                } else if (this.exploded && this.life > 0) {
                    // ç»˜åˆ¶ç‡ƒçƒ§èŒƒå›´
                    ctx.save();
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç»˜åˆ¶ç«ç„°ç‰¹æ•ˆ
                    const pulse = 1 + Math.sin(Date.now() * 0.01) * 0.2;
                    ctx.fillStyle = 'rgba(255, 100, 0, 0.6)';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius * 0.8 * pulse, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            }
        }

        class Grenade {
            constructor(team, thrower, startX, startY, targetX, targetY) {
                this.team = team;
                this.thrower = thrower;
                this.startX = startX; this.startY = startY;
                this.x = startX; this.y = startY;
                this.targetX = targetX; this.targetY = targetY;
                this.direction = Math.atan2(targetY - startY, targetX - startX);
                this.isFlying = true;
                this.exploded = false;
                this.radius = 80; // çˆ†ç‚¸èŒƒå›´æ”¹ä¸ºåŸæ¥çš„ä¸€åŠ
                this.damage = 50; // åŸºç¡€ä¼¤å®³
                this.explosionTime = 0; // çˆ†ç‚¸æ—¶é—´ï¼Œç”¨äºé—ªå…‰æ•ˆæœ
                this.flightTime = 0; // é£è¡Œæ—¶é—´ï¼Œç”¨äº2ç§’åçˆ†ç‚¸
            }
            update(dt) {
                if (this.isFlying) {
                    // å‘å‰é£è¡Œï¼Œé€Ÿåº¦å˜ä¸ºåŸæ¥çš„1/4
                    const speed = 250 * dt;
                    this.x += Math.cos(this.direction) * speed;
                    this.y += Math.sin(this.direction) * speed;
                    
                    // æ›´æ–°é£è¡Œæ—¶é—´
                    this.flightTime += dt;
                    
                    // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç›®æ ‡ç‚¹ä½æˆ–é£è¡Œæ—¶é—´è¶…è¿‡2ç§’
                    const distToTarget = Math.sqrt((this.x - this.targetX)**2 + (this.y - this.targetY)**2);
                    if (distToTarget < 20 || this.flightTime > 2) {
                        this.isFlying = false;
                        this.explode();
                    }
                } else if (this.exploded) {
                    this.explosionTime += dt;
                }
            }
            explode() {
                this.exploded = true;
                this.explosionTime = 0;
                WeaponSounds.play('hegrenade_explode');
                this.dealDamage();
                
                // å½±å“å‘¨å›´çš„çƒŸé›¾
                state.smokes.forEach(smoke => {
                    if (!smoke.isFlying) {
                        const dist = Math.sqrt((this.x - smoke.x)**2 + (this.y - smoke.y)**2);
                        if (dist < this.radius) {
                            smoke.grenadeEffect = smoke.grenadeEffectMax;
                        }
                    }
                });
            }
            dealDamage() {
                state.players.forEach(p => {
                    if (p.isAlive) {
                        const dist = Math.sqrt((p.x - this.x)**2 + (p.y - this.y)**2);
                        if (dist < this.radius) {
                            // è®¡ç®—ä¼¤å®³ï¼š100-è·çˆ†ç‚¸ç‚¹è·ç¦»ï¼ˆå¦‚æœæ˜¯è´Ÿæ•°åˆ™å¿½ç•¥ï¼‰
                            let damage = Math.max(0, 100 - dist);
                            
                            // å¦‚æœç©¿ç€æŠ¤ç”²ï¼Œä¼¤å®³å‡åŠ
                            if (p.armorType !== 'ç©º') {
                                damage *= 0.5;
                            }
                            
                            if (damage > 0) {
                                p.hp -= damage;
                                p.hitFlash = 1.0;
                                
                                // æ£€æŸ¥æ˜¯å¦æ­»äº¡
                                if (p.hp <= 0) {
                                    p.hp = 0;
                                    p.isAlive = false;
                                    p.deaths++;
                                    
                                    if (WEAPONS[p.weapon].isMain) {
                                        state.droppedWeapons.push(new DroppedWeapon(p.weapon, p.x, p.y));
                                    }

                                    if (p.isPlanting) { 
                                        state.bomb.state = 'idle'; 
                                        state.bomb.carrier = null; 
                                        state.bomb.x = p.x; 
                                        state.bomb.y = p.y; 
                                        state.bomb.node = p.posNode; 
                                        p.hasBomb = false; 
                                    }
                                    if (p.hasBomb) { 
                                        state.bomb.carrier = null; 
                                        state.bomb.x = p.x; 
                                        state.bomb.y = p.y; 
                                        state.bomb.node = p.posNode; 
                                        p.hasBomb = false; 
                                    }
                                    if (state.bomb.defuser === p) { 
                                        state.bomb.defuser = null; 
                                        state.bomb.defuseProgress = 0; 
                                        document.getElementById('defuse-bar-bg').classList.add('hidden'); 
                                    }
                                    
                                    // æ·»åŠ æ‰‹é›·å‡»æ€åé¦ˆ
                                    if (this.thrower === p) {
                                        // ç‚¸æ­»è‡ªå·±
                                        addKillFeed(p, p, 'â˜ ï¸', false);
                                    } else {
                                        // ç‚¸æ­»æ•Œäººæˆ–é˜Ÿå‹
                                        if (this.thrower) {
                                            addKillFeed(this.thrower, p, 'ğŸ’£', false);
                                        } else {
                                            // å¦‚æœæ‰¾ä¸åˆ°æŠ•æ·è€…ï¼Œæ˜¾ç¤ºç¯å¢ƒä¼¤å®³
                                            addKillFeed({ name: 'ğŸ’£', team: this.team }, p, 'ğŸ’£', false);
                                        }
                                    }
                                    checkRoundEnd();
                                }
                            }
                        }
                    }
                });
            }
            draw(ctx) {
                if (this.isFlying) {
                    // ç»˜åˆ¶ç»¿è‰²åœ†å½¢æ‰‹é›·ï¼Œå¤§å°æ”¹ä¸ºåŸæ¥çš„ä¸€åŠ
                    ctx.save();
                    ctx.fillStyle = 'green';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    ctx.restore();
                } else if (this.exploded && this.explosionTime < 1) {
                    // ç»˜åˆ¶çˆ†ç‚¸ç‰¹æ•ˆï¼šé»„è‰²åœ†å½¢é—ªå…‰ï¼Œåœ¨æœ€é¡¶å±‚
                    ctx.save();
                    
                    // é—ªå…‰æ•ˆæœï¼šéšæ—¶é—´å˜åŒ–çš„é€æ˜åº¦å’Œå¤§å°
                    const alpha = 1 - this.explosionTime;
                    const size = 50 + this.explosionTime * 25;
                    
                    // ç»˜åˆ¶é»„è‰²é—ªå…‰
                    ctx.fillStyle = `rgba(255, 200, 0, ${alpha * 0.9})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç»˜åˆ¶ç™½è‰²é«˜å…‰
                    ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.6})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, size * 0.6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç»˜åˆ¶å¤–å±‚å…‰æ™•
                    ctx.strokeStyle = `rgba(255, 255, 150, ${alpha * 0.7})`;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, size * 1.2, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    ctx.restore();
                }
            }
        }

        class Player {
            constructor(team, config, idx) {
                this.team = team; this.name = config.n; this.role = config.r;
                this.id = ''; // é€‰æ‰‹IDåˆå§‹å€¼ä¸ºç©º
                this.hp = 100; this.kills = 0; this.deaths = 0;
                this.isAlive = true; this.hasBomb = false;
                this.angle = 0; this.targetAngle = 0;
                this.viewDistance = 250; this.viewAngle = 35 * (Math.PI / 180);
                this.lastShot = 0; this.aimingAt = null;
                this.isReloading = false; this.reloadStart = 0;
                this.hitFlash = 0;
                this.isPlanting = false;
                this.hasKit = false; 
                this.defuseCooldown = 0;
                this.isHitReacting = false; // å—å‡»ååº”æ ‡å¿—
                this.isMoving = false; // è·Ÿè¸ªç©å®¶æ˜¯å¦åœ¨ç§»åŠ¨çŠ¶æ€
                this.isDefending = false; // è·Ÿè¸ªç©å®¶æ˜¯å¦åœ¨é˜²å®ˆçŠ¶æ€
                this.isOnFire = false; // è·Ÿè¸ªç©å®¶æ˜¯å¦æ­£åœ¨å—åˆ°ç‡ƒçƒ§ä¼¤å®³
                this.lastFireCheck = 0; // ä¸Šæ¬¡æ£€æŸ¥ç‡ƒçƒ§ä¼¤å®³çš„æ—¶é—´
                this.isEscapingFire = false; // è·Ÿè¸ªç©å®¶æ˜¯å¦æ­£åœ¨æ‰§è¡Œè¸©ç«é€ƒç¦»ä»»åŠ¡
                
                this.money = 800; 
                this.armorType = 'ç©º';
                this.utility = { smoke: 0, fire: 0, flash: 0, nade: 0 }; 

                this.strafeMode = Math.random() > 0.5 ? 'strafe' : 'stationary';
                this.strafeDir = 1; this.strafeTimer = 0;
                this.idleWatchTimer = 1 + Math.random() * 9;
                this.helpRequested = false;
                this.tempTarget = null;
                this.smokeWaitTimer = 0;
                this.isStuckInSmoke = false;
                this.blindTimer = 0;

                this.weapon = this.team === 'T' ? 'Glock-18' : 'USP-S';
                this.ammo = WEAPONS[this.weapon].ammo;
                const spawn = team === 'T' ? 'åŒªå®¶' : 'è­¦å®¶';
                this.x = MAP_NODES[spawn].x + (idx % 5 - 2) * 25;
                this.y = MAP_NODES[spawn].y + (Math.random() - 0.5) * 20;
                this.posNode = spawn;
                this.setTactics(idx);
            }

            blind(duration) {
                this.blindTimer = duration;
                if (state.bomb.defuser === this) {
                    state.bomb.defuser = null;
                    state.bomb.defuseProgress = 0;
                    document.getElementById('defuse-bar-bg').classList.add('hidden');
                }
            }

            buy(strategy = 'Full', isHero = false) {
                // ä¿®æ”¹ç‚¹ 1ï¼šæ‰‹æªå±€æŒ‡æŒ¥å®˜ç­–ç•¥ (5-0, 4-1, 3-2)
                if (state.round === 1 || state.round === 13) {
                    this.weapon = this.team === 'T' ? 'Glock-18' : 'USP-S';
                    this.ammo = WEAPONS[this.weapon].ammo;
                    this.armorType = 'ç©º';
                    this.utility = { smoke: 0, fire: 0, flash: 0, nade: 0 };
                    this.hasKit = false;

                    const pistolStrats = ['5-0', '4-1', '3-2'];
                    // åŸºäºå›åˆéšæœºé€‰ä¸€ä¸ªç­–ç•¥ï¼Œæˆ–è€…è®©ä¸¤ä¸ªé˜Ÿä¼é€‰ä¸åŒçš„
                    const stratKey = (this.team === 'T') ? state.round % 3 : (state.round + 1) % 3;
                    const roundStrat = pistolStrats[stratKey];
                    const armorNeeded = parseInt(roundStrat.split('-')[0]);
                    
                    // è·å–å½“å‰é€‰æ‰‹åœ¨é˜Ÿä¼é‡Œçš„ç´¢å¼• (0-4)
                    const teamIdx = state.players.filter(p => p.team === this.team).indexOf(this);

                    if (teamIdx < armorNeeded) {
                        // å±äºä¹°ç”²çš„é‚£éƒ¨åˆ†äºº
                        this.armorType = 'æŠ¤ç”²';
                        this.money -= 650;
                    } else {
                        // å±äºä¹°é“å…·çš„é‚£éƒ¨åˆ†äºº (æ ¹æ®å‰©ä½™é’±ä¹°çƒŸå’Œé—ª)
                        this.utility.smoke = 1;
                        this.utility.flash = 1;
                        this.money -= 500;
                        if (this.team === 'CT' && this.money >= 400 && Math.random() > 0.5) {
                            this.hasKit = true;
                            this.money -= 400;
                        }
                    }
                    return;
                }

                if (strategy === 'Eco') return; 
                if (strategy === 'Hero' && !isHero) return;

                const currentIsPistol = !WEAPONS[this.weapon].isMain;
                
                // å¼ºèµ·ç­–ç•¥ä¸‹çš„è´­ä¹°ä¼˜å…ˆçº§ï¼šæŠ¤ç”²ã€ä¸»æ­¦å™¨ã€é“å…·ã€é’³å­
                if (strategy === 'Force') {
                    // 1. æŠ¤ç”²è´­ä¹°ï¼šTæ–¹100%è´­ä¹°æŠ¤ç”²+å¤´ç›”ï¼ŒCT50%è´­ä¹°æŠ¤ç”²ï¼Œ50%æ¦‚ç‡è´­ä¹°æŠ¤ç”²+å¤´ç›”
                    if (this.armorType === 'ç©º') {
                        if (this.team === 'T') {
                            // Tæ–¹100%è´­ä¹°æŠ¤ç”²+å¤´ç›”
                            if (this.money >= 1000) {
                                this.armorType = 'æŠ¤ç”²+å¤´ç›”';
                                this.money -= 1000;
                            }
                        } else {
                            // CTæ–¹50%è´­ä¹°æŠ¤ç”²ï¼Œ50%æ¦‚ç‡è´­ä¹°æŠ¤ç”²+å¤´ç›”
                            const rand = Math.random();
                            if (rand < 0.5) {
                                // 50%è´­ä¹°æŠ¤ç”²
                                if (this.money >= 650) {
                                    this.armorType = 'æŠ¤ç”²';
                                    this.money -= 650;
                                }
                            } else {
                                // 50%è´­ä¹°æŠ¤ç”²+å¤´ç›”
                                if (this.money >= 1000) {
                                    this.armorType = 'æŠ¤ç”²+å¤´ç›”';
                                    this.money -= 1000;
                                }
                            }
                        }
                    }
                    
                    // 2. ä¸»æ­¦å™¨è´­ä¹°ï¼šå¯¹äºç‹™å‡»æ‰‹ï¼ŒAWPä¼˜å…ˆçº§æœ€å¤§ï¼›æ­£å¸¸ä¼˜å…ˆçº§ï¼šak47/m4a1>mac-10/mp9
                    if (currentIsPistol) {
                        // ç‹™å‡»æ‰‹ä¼˜å…ˆè´­ä¹°AWP
                        if (this.role === 'AWP' && this.money >= WEAPONS['AWP'].price) {
                            this.weapon = 'AWP';
                            this.money -= WEAPONS['AWP'].price;
                            this.ammo = WEAPONS[this.weapon].ammo;
                        } else if (this.money >= 2900) {
                            // æœ‰é’±çš„è¯ä¼˜å…ˆè´­ä¹°é•¿æª
                            const price = this.team === 'T' ? 2700 : 2900;
                            if (this.money >= price) {
                                this.weapon = this.team === 'T' ? 'AK-47' : 'M4A1-S';
                                this.money -= price;
                                this.ammo = WEAPONS[this.weapon].ammo;
                            }
                        } else if (this.team === 'T' && this.money >= WEAPONS['MAC-10'].price) {
                            // Tæ–¹å¼ºèµ·è´­ä¹°MAC-10
                            this.weapon = 'MAC-10';
                            this.money -= WEAPONS['MAC-10'].price;
                            this.ammo = WEAPONS[this.weapon].ammo;
                        } else if (this.team === 'CT' && this.money >= WEAPONS['MP9'].price) {
                            // CTæ–¹å¼ºèµ·è´­ä¹°MP9
                            this.weapon = 'MP9';
                            this.money -= WEAPONS['MP9'].price;
                            this.ammo = WEAPONS[this.weapon].ammo;
                        }
                    }
                    
                    // 3. é“å…·è´­ä¹°
                    const buyOrder = ['smoke', 'fire', 'flash', 'nade', 'flash'];
                    for (let item of buyOrder) {
                        if (this.money < 300) break;
                        let totalUtil = Object.values(this.utility).reduce((a,b)=>a+b, 0);
                        if (totalUtil >= 4) break;
                        let limit = (item === 'flash') ? 2 : 1;
                        if (this.utility[item] < limit && this.money >= UTILITY_PRICES[item]) {
                            this.utility[item]++;
                            this.money -= UTILITY_PRICES[item];
                        }
                    }
                    
                    // 4. é’³å­è´­ä¹°ï¼ˆå¯¹äºCTæ–¹è€Œè¨€ï¼‰
                    if (this.team === 'CT' && !this.hasKit && this.money >= 400) {
                        this.hasKit = true;
                        this.money -= 400;
                    }
                } else {
                    // éå¼ºèµ·ç­–ç•¥
                    if (currentIsPistol) {
                        // å…¨èµ·å±€å‘æªæ±‚åŠ©é€»è¾‘
                    if (strategy === 'Full') {
                        // ç‹™å‡»æ‰‹è´­ä¹°AWPçš„é€»è¾‘
                        if (this.role === 'AWP') {
                            if (this.money >= WEAPONS['AWP'].price) {
                                this.weapon = 'AWP'; 
                                this.money -= WEAPONS['AWP'].price;
                                this.ammo = WEAPONS[this.weapon].ammo;
                            } else {
                                // å‘é€ç”µæŠ¥æ±‚åŠ©è´­ä¹°AWP
                                this.broadcastRadio(`éœ€è¦AWPï¼è¯·æ±‚æ”¯æ´ï¼`);
                                // æ‰¾åˆ°æ¢ç®—ä½™é¢å¤§äº9000ä¸”èƒ½æ”¯ä»˜AWPçš„ç©å®¶
                                const teamPlayers = state.players.filter(p => p.team === this.team && p !== this);
                                const potentialHelpers = teamPlayers.filter(p => {
                                    return p.getConvertedBalance() > 9000 && p.money >= WEAPONS['AWP'].price;
                                });
                                
                                if (potentialHelpers.length > 0) {
                                    // é€‰æ‹©ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ç©å®¶
                                    const helper = potentialHelpers[0];
                                    helper.money -= WEAPONS['AWP'].price;
                                    this.weapon = 'AWP';
                                    this.ammo = WEAPONS[this.weapon].ammo;
                                    this.broadcastRadio(`æ„Ÿè°¢ ${helper.name} æä¾›AWPï¼`);
                                    helper.broadcastRadio(`å·²ä¸º ${this.name} è´­ä¹°AWP`);
                                } else {
                                    // æ²¡æœ‰èƒ½æä¾›AWPçš„ç©å®¶ï¼ŒæŒ‰ç…§æ­¥æªæ‰‹æ±‚åŠ©é€»è¾‘
                                    this.broadcastRadio(`éœ€è¦æ­¥æªï¼è¯·æ±‚æ”¯æ´ï¼`);
                                    const rifleHelpers = teamPlayers.filter(p => {
                                        return p.getConvertedBalance() > 7000 && p.money >= (this.team === 'T' ? WEAPONS['AK-47'].price : WEAPONS['M4A1-S'].price);
                                    });
                                    
                                    if (rifleHelpers.length > 0) {
                                        const helper = rifleHelpers[0];
                                        const riflePrice = this.team === 'T' ? WEAPONS['AK-47'].price : WEAPONS['M4A1-S'].price;
                                        helper.money -= riflePrice;
                                        this.weapon = this.team === 'T' ? 'AK-47' : 'M4A1-S';
                                        this.ammo = WEAPONS[this.weapon].ammo;
                                        this.broadcastRadio(`æ„Ÿè°¢ ${helper.name} æä¾›æ­¥æªï¼`);
                                        helper.broadcastRadio(`å·²ä¸º ${this.name} è´­ä¹°æ­¥æª`);
                                    }
                                }
                            }
                        } else {
                            // æ­¥æªæ‰‹è´­ä¹°æ­¥æªçš„é€»è¾‘
                            const riflePrice = this.team === 'T' ? WEAPONS['AK-47'].price : WEAPONS['M4A1-S'].price;
                            if (this.money >= riflePrice) {
                                this.weapon = this.team === 'T' ? 'AK-47' : 'M4A1-S';
                                this.money -= riflePrice;
                                this.ammo = WEAPONS[this.weapon].ammo;
                            } else {
                                // å‘é€ç”µæŠ¥æ±‚åŠ©è´­ä¹°æ­¥æª
                                this.broadcastRadio(`éœ€è¦æ­¥æªï¼è¯·æ±‚æ”¯æ´ï¼`);
                                // æ‰¾åˆ°æ¢ç®—ä½™é¢å¤§äº7000ä¸”èƒ½æ”¯ä»˜æ­¥æªçš„ç©å®¶
                                const teamPlayers = state.players.filter(p => p.team === this.team && p !== this);
                                const potentialHelpers = teamPlayers.filter(p => {
                                    return p.getConvertedBalance() > 7000 && p.money >= riflePrice;
                                });
                                
                                if (potentialHelpers.length > 0) {
                                    // é€‰æ‹©ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ç©å®¶
                                    const helper = potentialHelpers[0];
                                    helper.money -= riflePrice;
                                    this.weapon = this.team === 'T' ? 'AK-47' : 'M4A1-S';
                                    this.ammo = WEAPONS[this.weapon].ammo;
                                    this.broadcastRadio(`æ„Ÿè°¢ ${helper.name} æä¾›æ­¥æªï¼`);
                                    helper.broadcastRadio(`å·²ä¸º ${this.name} è´­ä¹°æ­¥æª`);
                                } else if (this.team === 'T' && this.money >= WEAPONS['MAC-10'].price) {
                                    // Tæ–¹è´­ä¹°MAC-10
                                    this.weapon = 'MAC-10';
                                    this.money -= WEAPONS['MAC-10'].price;
                                    this.ammo = WEAPONS[this.weapon].ammo;
                                } else if (this.team === 'CT' && this.money >= WEAPONS['MP9'].price) {
                                    // CTæ–¹è´­ä¹°MP9
                                    this.weapon = 'MP9';
                                    this.money -= WEAPONS['MP9'].price;
                                    this.ammo = WEAPONS[this.weapon].ammo;
                                }
                            }
                        }
                    } else {
                        // éå…¨èµ·å±€çš„åŸæœ‰é€»è¾‘
                        // ç‹™å‡»æ‰‹ä¼˜å…ˆè´­ä¹°AWP
                        if (this.role === 'AWP' && this.money >= WEAPONS['AWP'].price) {
                            this.weapon = 'AWP'; 
                            this.money -= WEAPONS['AWP'].price;
                            this.ammo = WEAPONS[this.weapon].ammo;
                        } else if (this.money >= 2900) {
                            // æœ‰é’±çš„è¯ä¼˜å…ˆè´­ä¹°é•¿æª
                            const price = this.team === 'T' ? 2700 : 2900;
                            if (this.money >= price) {
                                this.weapon = this.team === 'T' ? 'AK-47' : 'M4A1-S';
                                this.money -= price;
                                this.ammo = WEAPONS[this.weapon].ammo;
                            }
                        } else if (this.team === 'T' && this.money >= WEAPONS['MAC-10'].price) {
                            // Tæ–¹è´­ä¹°MAC-10
                            this.weapon = 'MAC-10';
                            this.money -= WEAPONS['MAC-10'].price;
                            this.ammo = WEAPONS[this.weapon].ammo;
                        } else if (this.team === 'CT' && this.money >= WEAPONS['MP9'].price) {
                            // CTæ–¹è´­ä¹°MP9
                            this.weapon = 'MP9';
                            this.money -= WEAPONS['MP9'].price;
                            this.ammo = WEAPONS[this.weapon].ammo;
                        }
                    }
                } else if (this.money >= 4750 && this.role === 'AWP' && this.weapon !== 'AWP') {
                    // éæ‰‹æªçŠ¶æ€ä¸‹ï¼Œç‹™å‡»æ‰‹ä¹Ÿä¼˜å…ˆè´­ä¹°AWP
                    this.weapon = 'AWP'; 
                    this.money -= WEAPONS['AWP'].price;
                    this.ammo = WEAPONS[this.weapon].ammo;
                }

                // åŠèµ·å±€ç­–ç•¥
                if (strategy === 'Half') {
                    if (this.money > 2500) {
                        // é‡‘é’±æ•°>2500ï¼Œè´­ä¹°deagleæˆ–è€…tec-9/fn57
                        if (this.team === 'CT') {
                            const handguns = ['FN57', 'Deagle'];
                            const chosenGun = handguns[Math.floor(Math.random() * handguns.length)];
                            if (this.money >= WEAPONS[chosenGun].price) {
                                this.weapon = chosenGun;
                                this.money -= WEAPONS[chosenGun].price;
                                this.ammo = WEAPONS[this.weapon].ammo;
                            }
                        } else {
                            const handguns = ['Tec-9', 'Deagle'];
                            const chosenGun = handguns[Math.floor(Math.random() * handguns.length)];
                            if (this.money >= WEAPONS[chosenGun].price) {
                                this.weapon = chosenGun;
                                this.money -= WEAPONS[chosenGun].price;
                                this.ammo = WEAPONS[this.weapon].ammo;
                            }
                        }
                    } else if (this.money >= 2200 && this.money <= 2400) {
                        // é‡‘é’±æ•°2200-2400ï¼Œè´­ä¹°é—ªå…‰å’Œæ‰‹é›·
                        if (this.money >= UTILITY_PRICES.flash) {
                            this.utility.flash = 1;
                            this.money -= UTILITY_PRICES.flash;
                        }
                        if (this.money >= UTILITY_PRICES.nade) {
                            this.utility.nade = 1;
                            this.money -= UTILITY_PRICES.nade;
                        }
                    }
                    // å…¶ä»–æƒ…å†µä¸€å¾‹ä¸ä¹°
                } else {
                        // éåŠèµ·å±€ç­–ç•¥çš„æŠ¤ç”²è´­ä¹°
                        if (this.money >= 1000 && this.armorType === 'ç©º') {
                            this.armorType = 'æŠ¤ç”²+å¤´ç›”';
                            this.money -= 1000;
                        }

                        // é“å…·è´­ä¹°
                        const buyOrder = ['smoke', 'fire', 'flash', 'nade', 'flash'];
                        for (let item of buyOrder) {
                            if (this.money < 300) break;
                            let totalUtil = Object.values(this.utility).reduce((a,b)=>a+b, 0);
                            if (totalUtil >= 4) break;
                            let limit = (item === 'flash') ? 2 : 1;
                            if (this.utility[item] < limit && this.money >= UTILITY_PRICES[item]) {
                                this.utility[item]++;
                                this.money -= UTILITY_PRICES[item];
                            }
                        }
                    }

                    if (this.team === 'CT' && !this.hasKit && this.money >= 400 && strategy === 'Full') {
                        this.hasKit = true;
                        this.money -= 400;
                    }
                }
                
                // è®¾ç½®ç‹™å‡»æ‰‹æŒæœ‰AWPæ—¶çš„ç‰¹æ®Šåˆå§‹ä½ç½®
                this.setSniperTactics();
            }

            throwSmoke(targetNode) {
                if (this.utility.smoke > 0) {
                    this.utility.smoke--;
                    state.smokes.push(new Smoke(this.team, this.x, this.y, targetNode));
                    this.broadcastRadio(`æ”¶åˆ°ï¼ŒæŠ•æ·çƒŸé›¾å¼¹è‡³ ${targetNode}ï¼`);
                }
            }

            throwFlash(targetNode) {
                if (this.utility.flash > 0) {
                    this.utility.flash--;
                    state.flashes.push(new Flash(this.team, this.x, this.y, targetNode));
                    this.broadcastRadio(`æ”¶åˆ°ï¼ŒæŠ•æ·é—ªå…‰å¼¹è‡³ ${targetNode}ï¼`);
                }
            }

            throwMolotov(targetNode) {
                if (this.utility.fire > 0) {
                    this.utility.fire--;
                    state.molotovs.push(new Molotov(this.team, this, this.x, this.y, targetNode));
                    this.broadcastRadio(`æ”¶åˆ°ï¼ŒæŠ•æ·ç‡ƒçƒ§ç“¶è‡³ ${targetNode}ï¼`);
                }
            }

            throwNade() {
                if (this.utility.nade > 0) {
                    this.utility.nade--;
                    state.grenades.push(new Grenade(this.team, this, this.x, this.y, this.angle));
                    this.broadcastRadio(`æŠ•æ·æ‰‹é›·ï¼`);
                }
            }

            setTactics(idx) {
                if (this.team === 'T') {
                    // Tæ–¹åˆå§‹è¿›æ”»æ–¹å‘ï¼šaé—¨ã€aé—¨å¤–ã€aå°ä¸Šã€aå°ä¸‹ã€æ²™åœ°ã€b1ã€b2ï¼Œéšæœºåˆ†é…
                    const tDestinations = ['aé—¨', 'aé—¨å¤–', 'aå°ä¸Š', 'aå°ä¸‹', 'æ²™åœ°', 'b1', 'b2'];
                    this.destination = tDestinations[Math.floor(Math.random() * tDestinations.length)];
                } else {
                    this.destination = ['aç‚¹', 'bç‚¹', 'aå°ä¸‹', 'æ²™åœ°', 'è­¦å®¶', 'aé—¨å¤–'][idx % 6];
                }
                this.path = findPath(this.posNode, this.destination);
                this.pathIdx = 1;
            }
            
            // è®¾ç½®ç‹™å‡»æ‰‹æŒæœ‰AWPæ—¶çš„ç‰¹æ®Šåˆå§‹ä½ç½®
            setSniperTactics() {
                if (this.role === 'AWP' && this.weapon === 'AWP') {
                    if (this.team === 'T') {
                        // Tæ–¹ç‹™å‡»æ‰‹æŒæœ‰AWPæ—¶ï¼Œåˆå§‹ä¼šå‰å¾€ä¸­è·¯
                        this.destination = 'ä¸­è·¯';
                    } else {
                        // CTæ–¹ç‹™å‡»æ‰‹æŒæœ‰AWPæ—¶ï¼Œåˆå§‹ä¼šå‰å¾€æ²™åœ°
                        this.destination = 'æ²™åœ°';
                    }
                    this.path = findPath(this.posNode, this.destination);
                    this.pathIdx = 1;
                }
            }
            
            // è®¡ç®—æ¢ç®—ä½™é¢ï¼ˆæªæ¢°ã€é“å…·ã€æŠ¤ç”²çš„æ€»ä»·æ ¼+å­˜æ¬¾ï¼‰
            getConvertedBalance() {
                let assetsValue = 0;
                if (WEAPONS[this.weapon]) assetsValue += WEAPONS[this.weapon].price;
                if (this.armorType === 'æŠ¤ç”²+å¤´ç›”') assetsValue += 1000;
                else if (this.armorType === 'æŠ¤ç”²') assetsValue += 650;
                assetsValue += (this.utility.smoke * UTILITY_PRICES.smoke);
                assetsValue += (this.utility.fire * UTILITY_PRICES.fire);
                assetsValue += (this.utility.flash * UTILITY_PRICES.flash);
                assetsValue += (this.utility.nade * UTILITY_PRICES.nade);
                if (this.hasKit) assetsValue += 400;
                return assetsValue + this.money;
            }

            broadcastRadio(msg) {
                const teamPlayers = state.players.filter(p => p.team === this.team);
                const commanders = teamPlayers.filter(p => p.role === 'Rifle');
                const isCommander = commanders.length > 0 && this.name === commanders[0].name;
                if (!this.isAlive && !isCommander) return;
                const senderDisplay = this.name + (!this.isAlive ? " (æ­»äº¡)" : "");
                state.radioHistory[this.team].push({ sender: senderDisplay, team: this.team, text: msg, time: Date.now() });
                if (state.radioHistory[this.team].length > 25) state.radioHistory[this.team].shift();
                if (state.radioView === this.team) updateRadioUI();
            }

            isIdle() { return !this.aimingAt && this.pathIdx >= this.path.length && !this.tempTarget; }

            update(dt, now) {
                if (!this.isAlive) return;

                state.droppedWeapons.forEach((dw, i) => {
                    const dist = Math.sqrt((this.x - dw.x)**2 + (this.y - dw.y)**2);
                    if (dist < 20) {
                        let shouldPick = false;
                        
                        // æ­¦å™¨ä¼˜å…ˆçº§æ˜ å°„ï¼šæ•°å€¼è¶Šé«˜ä¼˜å…ˆçº§è¶Šé«˜
                        const weaponPriority = {
                            'MAC-10': 1,
                            'MP9': 2,
                            'M4A1-S': 3,
                            'AK-47': 4,
                            'AWP': 10 // AWPä¼˜å…ˆçº§æœ€é«˜
                        };
                        
                        // è·å–å½“å‰æ­¦å™¨å’Œæ‰è½æ­¦å™¨çš„ä¼˜å…ˆçº§
                        const currentPriority = weaponPriority[this.weapon] || 0;
                        const droppedPriority = weaponPriority[dw.name] || 0;
                        
                        // åˆ¤æ–­æ˜¯å¦åº”è¯¥æ¡èµ·
                        if (!WEAPONS[this.weapon].isMain) {
                            // æ²¡æœ‰ä¸»æ­¦å™¨ï¼Œç›´æ¥æ¡èµ·ï¼ˆéç‹™å‡»æ‰‹ä¸æ¡AWPï¼‰
                            if (dw.name === 'AWP' && this.role !== 'AWP') {
                                shouldPick = false;
                            } else {
                                shouldPick = true;
                            }
                        } else if (this.role === 'AWP' && dw.name === 'AWP' && this.weapon !== 'AWP') {
                            // ç‹™å‡»æ‰‹çœ‹åˆ°AWPï¼Œç›´æ¥æ¡èµ·
                            shouldPick = true;
                        } else if (WEAPONS[dw.name].isMain && droppedPriority > currentPriority) {
                            // æ‰è½æ­¦å™¨æ˜¯ä¸»æ­¦å™¨ä¸”ä¼˜å…ˆçº§é«˜äºå½“å‰æ­¦å™¨ï¼ˆéç‹™å‡»æ‰‹ä¸æ¡AWPï¼‰
                            if (dw.name === 'AWP' && this.role !== 'AWP') {
                                shouldPick = false;
                            } else {
                                shouldPick = true;
                            }
                        }

                        if (shouldPick) {
                            const oldWeapon = this.weapon;
                            this.weapon = dw.name;
                            this.ammo = WEAPONS[this.weapon].ammo;
                            state.droppedWeapons.splice(i, 1);
                            if (WEAPONS[oldWeapon].isMain) {
                                state.droppedWeapons.push(new DroppedWeapon(oldWeapon, this.x, this.y));
                            }
                            this.broadcastRadio(`æ‹¾å–äº† ${this.weapon}ã€‚`);
                        }
                    }
                });
                
                // ç‡ƒçƒ§ä¼¤å®³æ£€æŸ¥é€»è¾‘ï¼šæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦ä»ç„¶åœ¨ç‡ƒçƒ§
                if (this.isOnFire) {
                    this.lastFireCheck += dt * state.speed;
                    if (this.lastFireCheck >= 5.0) {
                        this.lastFireCheck = 0;
                        
                        // æ£€æŸ¥å½“å‰ä½ç½®æ˜¯å¦æœ‰ç‡ƒçƒ§ç“¶
                        const isInFire = state.molotovs.some(m => {
                            if (!m.exploded || m.life <= 0) return false;
                            const dist = Math.sqrt((this.x - m.x)**2 + (this.y - m.y)**2);
                            return dist < m.radius;
                        });
                        
                        if (isInFire) {
                            // å¯»æ‰¾å‘¨å›´æ²¡æœ‰ç«çš„å®‰å…¨åœ°ç‚¹
                            const currentNode = MAP_NODES[this.posNode];
                            const safeNodes = [];
                            
                            // æ£€æŸ¥å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰ç›¸é‚»èŠ‚ç‚¹
                            if (currentNode.links) {
                                currentNode.links.forEach(linkNode => {
                                    const link = MAP_NODES[linkNode];
                                    
                                    // æ£€æŸ¥è¯¥ç›¸é‚»èŠ‚ç‚¹æ˜¯å¦æœ‰ç‡ƒçƒ§ç“¶
                                    const isLinkSafe = !state.molotovs.some(m => {
                                        if (!m.exploded || m.life <= 0) return false;
                                        const dist = Math.sqrt((link.x - m.x)**2 + (link.y - m.y)**2);
                                        return dist < m.radius;
                                    });
                                    
                                    if (isLinkSafe) {
                                        safeNodes.push(linkNode);
                                    }
                                });
                            }
                            
                            // å¦‚æœæ‰¾åˆ°å®‰å…¨åœ°ç‚¹ï¼Œå‰å¾€è¯¥åœ°ç‚¹
                            if (safeNodes.length > 0) {
                                const safeTarget = safeNodes[Math.floor(Math.random() * safeNodes.length)];
                                this.destination = safeTarget;
                                this.path = findPath(this.posNode, safeTarget);
                                this.pathIdx = 0;
                                this.broadcastRadio(`æ­£åœ¨é€ƒç¦»ç«ç„°ï¼Œå‰å¾€ ${safeTarget}ï¼`);
                            } else {
                                // å¦‚æœæ²¡æœ‰å®‰å…¨åœ°ç‚¹ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªç›¸é‚»èŠ‚ç‚¹
                                if (currentNode.links && currentNode.links.length > 0) {
                                    const randomTarget = currentNode.links[Math.floor(Math.random() * currentNode.links.length)];
                                    this.destination = randomTarget;
                                    this.path = findPath(this.posNode, randomTarget);
                                    this.pathIdx = 0;
                                    this.broadcastRadio(`æ­£åœ¨é€ƒç¦»ç«ç„°ï¼Œå‰å¾€ ${randomTarget}ï¼`);
                                }
                            }
                        } else {
                            // å¦‚æœå½“å‰ä½ç½®æ²¡æœ‰ç«ï¼Œæ ‡è®°ä¸ºä¸åœ¨ç‡ƒçƒ§çŠ¶æ€
                            this.isOnFire = false;
                        }
                    }
                }
                
                if (this.blindTimer > 0) {
                    this.blindTimer -= dt * state.speed;
                    if (this.blindTimer < 0) this.blindTimer = 0;
                }

                if (this.isPlanting) return;
                if (this.hitFlash > 0) this.hitFlash -= dt * 5 * state.speed;
                if (this.defuseCooldown > 0) this.defuseCooldown -= dt * state.speed;

                if (this.isReloading) {
                    if (now - this.reloadStart > WEAPONS[this.weapon].reload / state.speed) {
                        this.ammo = WEAPONS[this.weapon].ammo; this.isReloading = false;
                    }
                    return;
                }

                const isMoving = this.pathIdx < this.path.length || this.tempTarget !== null;
                if (this.weapon === 'AWP' && !isMoving) {
                    this.viewDistance = 250 * 1.5;
                    this.viewAngle = (35 * (Math.PI / 180)) / 2;
                } else if (WEAPONS[this.weapon] && WEAPONS[this.weapon].è§†é‡ç¼©çŸ­) {
                    this.viewDistance = 250 / 2;
                    this.viewAngle = (35 * (Math.PI / 180)) / 2;
                } else {
                    this.viewDistance = 250;
                    this.viewAngle = 35 * (Math.PI / 180);
                }
                if (this.team === 'T' && !this.hasBomb && state.bomb.state === 'idle' && !state.bomb.carrier) {
                    const distToBomb = Math.sqrt((this.x - state.bomb.x)**2 + (this.y - state.bomb.y)**2);
                    if (distToBomb < 15) {
                        this.hasBomb = true; state.bomb.carrier = this;
                        this.tempTarget = null;
                        this.broadcastRadio("æˆ‘æ‹¿å›åŒ…äº†ï¼ŒåŸåœ°å¾…å‘½ï¼");
                        this.destination = this.posNode;
                        this.path = [this.posNode];
                        this.pathIdx = 0;
                    }
                }

                if (this.team === 'CT' && state.bomb.state === 'planted' && this.blindTimer <= 0) {
                    const distToBomb = Math.sqrt((this.x - state.bomb.x)**2 + (this.y - state.bomb.y)**2);
                    const visibleEnemies = state.players.filter(p => p.isAlive && p.team === 'T' && this.canSee(p));
                    if (distToBomb < 15 && this.defuseCooldown <= 0 && visibleEnemies.length === 0 && (state.bomb.defuser === null || state.bomb.defuser === this)) {
                        if (state.bomb.defuser === null) {
                            state.bomb.defuser = this;
                            state.bomb.defuseProgress = 0;
                            this.broadcastRadio("æ­£åœ¨æ‹†é™¤ç‚¸å¼¹ï¼æ©æŠ¤æˆ‘ï¼");
                            document.getElementById('defuse-bar-bg').classList.remove('hidden');
                            WeaponSounds.play('c4_disarmstart');
                        }
                        const defuseTime = this.hasKit ? 5 : 10;
                        state.bomb.defuseProgress += (dt * state.speed / defuseTime) * 100;
                        document.getElementById('defuse-bar-fill').style.width = `${state.bomb.defuseProgress}%`;
                        if (state.bomb.defuseProgress >= 100) {
                            this.money += 300; 
                            WeaponSounds.play('bomb_defuse');
                            state.bomb.defuseProgress = 0; // é˜²æ­¢é‡å¤æ’­æ”¾éŸ³æ•ˆ
                            document.getElementById('defuse-bar-bg').classList.add('hidden'); // éšè—æ‹†å¼¹è¿›åº¦æ¡
                            endRound('CT', 'BOMB DEFUSED');
                        }
                        return; 
                    } else if (state.bomb.defuser === this) {
                        state.bomb.defuser = null;
                        state.bomb.defuseProgress = 0;
                        document.getElementById('defuse-bar-bg').classList.add('hidden');
                    }
                }

                const visibleEnemies = state.players.filter(p => p.isAlive && p.team !== this.team && this.canSee(p));
                this.aimingAt = (this.blindTimer <= 0) ? (visibleEnemies[0] || null) : null;
                this.handleHelpRadio(visibleEnemies);

                if (this.aimingAt) {
                    this.targetAngle = Math.atan2(this.aimingAt.y - this.y, this.aimingAt.x - this.x);
                    
                    // ä¿®æ”¹ç‚¹ï¼šç‹™å‡»æ‰‹å¼€ç«ç¬é—´ä¸æ™ƒåŠ¨
                    const isAWPPunishment = this.weapon === 'AWP' && (now - this.lastShot < 500 / state.speed);
                    
                    if (this.strafeMode === 'strafe' && !isAWPPunishment) {
                        this.strafeTimer -= dt;
                        if (this.strafeTimer <= 0) { this.strafeDir *= -1; this.strafeTimer = 0.4 + Math.random(); }
                        const sAngle = this.angle + Math.PI/2 * this.strafeDir;
                        this.x += Math.cos(sAngle) * 12.5 * dt * state.speed;
                        this.y += Math.sin(sAngle) * 12.5 * dt * state.speed;
                    }
                    let angleDiff = this.normalizeAngle(this.targetAngle - this.angle);
                    this.angle += Math.sign(angleDiff) * 8 * dt * state.speed;
                    if (Math.abs(angleDiff) < 0.1) {
                        this.shoot(this.aimingAt, now);
                    }
                } else {
                    if (this.isHitReacting) {
                        // å—å‡»æ—¶ä»¥ä¸¤å€é€Ÿåº¦æ—‹è½¬è§†è§’
                        let angleDiff = this.normalizeAngle(this.targetAngle - this.angle);
                        this.angle += Math.sign(angleDiff) * 6 * dt * state.speed; // æ­£å¸¸é€Ÿåº¦æ˜¯3ï¼Œè¿™é‡Œç”¨6
                        if (Math.abs(angleDiff) < 0.1) {
                            this.isHitReacting = false; // å®Œæˆè½¬å‘åé‡ç½®æ ‡å¿—
                        }
                    } else {
                        if (this.blindTimer <= 0) this.moveAlongPath(dt);
                        if (this.isIdle()) this.helpRequested = false; 
                    }
                }
            }

            handleHelpRadio(enemies) {
                if (this.helpRequested) return;
                let needHelp = false; let isUrgent = false;
                if (this.team === 'T') { if (enemies.length >= 2) needHelp = true; }
                else { if (enemies.length === 2) needHelp = true; if (enemies.length >= 3 || enemies.some(e => e.hasBomb)) { needHelp = true; isUrgent = true; } }
                if (needHelp) {
                    this.helpRequested = true;
                    this.broadcastRadio(isUrgent ? "è¿™é‡Œæœ‰å¤§é‡æ•Œäººæˆ–åŒ…åŒªï¼ï¼å¿«æ¥æ”¯æ´ï¼ï¼" : "é‡åˆ°å¤šåæ•Œäººï¼Œè¯·æ±‚æ”¯æ´ï¼");
                    state.players.forEach(p => {
                        if (p.team === this.team && p.isAlive && p !== this && p.isIdle()) {
                            if (isUrgent) { p.broadcastRadio("æ”¶åˆ°ï¼Œå…¨é€Ÿæ”¯æ´ï¼"); p.goToSupport(this.posNode); }
                            else { if (Math.random() < 0.5) { p.broadcastRadio("æ”¶åˆ°ï¼Œæ­£åœ¨èµ¶å¾€ä½ çš„ä½ç½®ã€‚"); p.goToSupport(this.posNode); } else { p.broadcastRadio("æ‹’ç»ï¼Œæˆ‘éœ€è¦å®ˆä½å½“å‰ä½ç½®ã€‚"); } }
                        }
                    });
                }
            }

            goToSupport(targetNode) {
                this.destination = targetNode;
                this.path = findPath(this.posNode, targetNode);
                this.pathIdx = 0;
            }

            moveAlongPath(dt) {
                // ä¿®æ”¹ç‚¹ 2ï¼šé’»çƒŸé€»è¾‘ä¿®æ”¹
                const enemySmoke = state.smokes.find(s => !s.isFlying && s.team !== this.team && Math.sqrt((this.x - s.x)**2 + (this.y - s.y)**2) < s.radius + 10);
                if (enemySmoke) {
                    this.smokeWaitTimer += dt * state.speed;
                    // æ¯ 5 ç§’ï¼ˆæ¨¡æ‹Ÿæ—¶é—´ï¼‰è¿›è¡Œä¸€æ¬¡å†³ç­–åˆ¤æ–­
                    if (this.smokeWaitTimer >= 5) {
                        this.smokeWaitTimer = 0;
                        // 50% å‡ ç‡åœæ­¢ï¼Œ50% å‡ ç‡ç»§ç»­å‰è¿›
                        this.isStuckInSmoke = Math.random() < 0.5;
                    }
                    if (this.isStuckInSmoke) {
                        this.isMoving = false;
                        return; 
                    }
                } else { 
                    this.smokeWaitTimer = 0;
                    this.isStuckInSmoke = false;
                }
                
                // è§†é‡ä¸­ç«çš„æ£€æµ‹ï¼šå¦‚æœè§†é‡ä¸­æœ‰ç«ä¸”ç©å®¶ä¸åœ¨é€ƒç¦»ç«åŒºï¼ŒåŸåœ°åœç•™ç›´åˆ°ç«æ¶ˆå¤±
                if (!this.isEscapingFire && !this.isOnFire) {
                    const isFireInSight = state.molotovs.some(m => {
                        if (!m.exploded || m.life <= 0) return false;
                        const dist = Math.sqrt((this.x - m.x)**2 + (this.y - m.y)**2);
                        if (dist > this.viewDistance) return false;
                        
                        // æ£€æŸ¥ç«æ˜¯å¦åœ¨è§†é‡èŒƒå›´å†…
                        const angleToFire = Math.atan2(m.y - this.y, m.x - this.x);
                        const angleDiff = Math.abs(this.normalizeAngle(angleToFire - this.angle));
                        return angleDiff < this.viewAngle / 2;
                    });
                    
                    if (isFireInSight) {
                        this.isMoving = false;
                        return; // è§†é‡ä¸­æœ‰ç«ï¼ŒåŸåœ°åœç•™
                    }
                }

                const speed = 75 * dt * state.speed;
                if (this.pathIdx < this.path.length) {
                    const next = MAP_NODES[this.path[this.pathIdx]];
                    const dx = next.x - this.x, dy = next.y - this.y;
                    const dist = Math.sqrt(dx*dx+dy*dy);
                    if (!this.aimingAt) {
                        this.targetAngle = Math.atan2(dy, dx);
                        let angleDiff = this.normalizeAngle(this.targetAngle - this.angle);
                        this.angle += Math.sign(angleDiff) * 3 * dt * state.speed;
                    }
                    if (dist > 5) {
                        this.x += (dx/dist) * speed; this.y += (dy/dist) * speed;
                        this.isMoving = true;
                    } else {
                        this.posNode = this.path[this.pathIdx];
                        this.pathIdx++;
                        this.isMoving = false;
                        
                        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾é€ƒç¦»ç«ç„°çš„ç›®æ ‡åœ°ç‚¹
                        if (this.isEscapingFire && this.pathIdx >= this.path.length) {
                            this.isEscapingFire = false; // ä»»åŠ¡å®Œæˆï¼Œé‡ç½®æ ‡å¿—
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾è·¯å¾„ç»ˆç‚¹
                        if (this.pathIdx >= this.path.length) {
                            // åˆ°è¾¾å›ºå®šåœ°ç‚¹ï¼Œç«‹å³è®¾ç½®è§†è§’æ–¹å‘ä¸ºå½“å‰èŠ‚ç‚¹çš„éšæœºç›¸é‚»èŠ‚ç‚¹
                            const currentNode = MAP_NODES[this.posNode];
                            if (currentNode.links.length > 0) {
                                const randomLink = currentNode.links[Math.floor(Math.random() * currentNode.links.length)];
                                const targetNode = MAP_NODES[randomLink];
                                this.targetAngle = Math.atan2(targetNode.y - this.y, targetNode.x - this.x);
                            }
                            // é‡ç½®idleWatchTimerä¸º3-10ç§’
                            this.idleWatchTimer = 3 + Math.random() * 7;
                        }
                        
                        if (this.hasBomb && MAP_NODES[this.posNode].type === 'site' && state.bomb.state === 'idle') this.plantBomb();
                    }
                } else if (this.tempTarget) {
                    const dx = this.tempTarget.x - this.x, dy = this.tempTarget.y - this.y;
                    const dist = Math.sqrt(dx*dx+dy*dy);
                    if (!this.aimingAt) this.targetAngle = Math.atan2(dy, dx);
                    if (dist > 5) {
                        this.x += (dx/dist) * speed; this.y += (dy/dist) * speed;
                        this.isMoving = true;
                    } else { 
                        this.tempTarget = null;
                        this.isMoving = false;
                        // åˆ°è¾¾ä¸´æ—¶ç›®æ ‡åï¼Œç«‹å³è®¾ç½®è§†è§’æ–¹å‘ä¸ºå½“å‰èŠ‚ç‚¹çš„éšæœºç›¸é‚»èŠ‚ç‚¹
                        const currentNode = MAP_NODES[this.posNode];
                        if (currentNode.links.length > 0) {
                            const randomLink = currentNode.links[Math.floor(Math.random() * currentNode.links.length)];
                            const targetNode = MAP_NODES[randomLink];
                            this.targetAngle = Math.atan2(targetNode.y - this.y, targetNode.x - this.x);
                        }
                        // é‡ç½®idleWatchTimerä¸º3-10ç§’
                        this.idleWatchTimer = 3 + Math.random() * 7;
                    }
                } else if (!this.aimingAt) {
                    if (this.isMoving) {
                        // åˆšè¿›å…¥é™æ­¢çŠ¶æ€ï¼Œç«‹å³éšæœºé€‰æ‹©ä¸€ä¸ªç›¸é‚»èŠ‚ç‚¹ä½œä¸ºè§†è§’æ–¹å‘
                        this.isMoving = false;
                        const currentNode = MAP_NODES[this.posNode];
                        if (currentNode.links.length > 0) {
                            // éšæœºé€‰æ‹©å½“å‰èŠ‚ç‚¹çš„ä¸€ä¸ªç›¸é‚»èŠ‚ç‚¹ä½œä¸ºè§†è§’æ–¹å‘
                            const randomLink = currentNode.links[Math.floor(Math.random() * currentNode.links.length)];
                            const targetNode = MAP_NODES[randomLink];
                            this.targetAngle = Math.atan2(targetNode.y - this.y, targetNode.x - this.x);
                        }
                        // é‡ç½®idleWatchTimerä¸º3-10ç§’
                        this.idleWatchTimer = 3 + Math.random() * 7;
                    } else {
                        // ä¿æŒé™æ­¢çŠ¶æ€ï¼Œç»§ç»­ä½¿ç”¨ç°æœ‰çš„idleWatchTimeré€»è¾‘
                        this.idleWatchTimer -= dt * state.speed;
                        if (this.idleWatchTimer <= 0) {
                            const currentNode = MAP_NODES[this.posNode];
                            if (currentNode.links.length > 0) {
                                // éšæœºé€‰æ‹©å½“å‰èŠ‚ç‚¹çš„ä¸€ä¸ªç›¸é‚»èŠ‚ç‚¹ä½œä¸ºè§†è§’æ–¹å‘
                                const randomLink = currentNode.links[Math.floor(Math.random() * currentNode.links.length)];
                                const targetNode = MAP_NODES[randomLink];
                                this.targetAngle = Math.atan2(targetNode.y - this.y, targetNode.x - this.x);
                            }
                            // æ¯éš”3~10ç§’åˆ‡æ¢ä¸€æ¬¡æ–¹å‘
                            this.idleWatchTimer = 3 + Math.random() * 7;
                        }
                    }
                    let angleDiff = this.normalizeAngle(this.targetAngle - this.angle);
                    this.angle += Math.sign(angleDiff) * 3 * dt * state.speed;
                }
            }

            shoot(target, now) {
                if (this.blindTimer > 0) return;
                if (!this.canSee(target)) return;

                const config = WEAPONS[this.weapon];
                if (this.ammo <= 0) { 
                    this.isReloading = true; 
                    this.reloadStart = now; 
                    WeaponSounds.play('reload'); // æ’­æ”¾æ¢å¼¹éŸ³æ•ˆ
                    return; 
                }
                if (now - this.lastShot < config.cd / state.speed) return;
                
                // AWP å¼€ç«ç¬é—´å¢åŠ ä¸€æ®µç¡¬ç›´ï¼Œé…åˆ update é‡Œçš„ isAWPPunishment
                if (this.weapon === 'AWP' && this.strafeMode === 'strafe') {
                    this.strafeTimer = 0.5; 
                }

                this.lastShot = now; this.ammo--;
                state.tracers.push({ x1: this.x, y1: this.y, x2: target.x, y2: target.y, life: 0.1 });
                
                // æ·»åŠ å¼€ç«ç‰¹æ•ˆ
                const fireSize = this.weapon === 'AWP' ? 15 : 10;
                const fireX = this.x + Math.cos(this.angle) * 15;
                const fireY = this.y + Math.sin(this.angle) * 15;
                state.fireEffects = state.fireEffects || [];
                state.fireEffects.push({ 
                    x: fireX, 
                    y: fireY, 
                    size: fireSize, 
                    life: 0.1, 
                    angle: this.angle 
                });
                
                // æ’­æ”¾æ­¦å™¨éŸ³æ•ˆ
                WeaponSounds.play(this.weapon);
                
                let hitChance = this.strafeMode === 'strafe' ? 0.25 : 0.45;
                if (this.weapon === 'AWP') {
                    // åˆ¤æ–­æ˜¯å¦å¤„äºå¼€ç«ç¬é—´çš„æ€¥åœçŠ¶æ€
                    const isActuallyMoving = this.strafeMode === 'strafe' && (now - this.lastShot > 100);
                    hitChance = isActuallyMoving ? 0.15 : 0.6;
                }
                if (this.weapon === 'M4A1-S') hitChance += 0.15;

                // USPçš„çˆ†å¤´ç‡ä¸º40%
                let isHS;
                if (this.weapon === 'USP-S') {
                    isHS = Math.random() > 0.5; // 40%çš„æ¦‚ç‡çˆ†å¤´
                } else {
                    isHS = Math.random() > 0.7; // 30%çš„æ¦‚ç‡çˆ†å¤´
                }
                const damage = isHS ? WEAPONS[this.weapon].headDamage : WEAPONS[this.weapon].damage;
                if (Math.random() < hitChance) target.receiveDamage(this, damage, isHS);
            }

            receiveDamage(attacker, amount, isHS) {
                this.hp -= amount; this.hitFlash = 1.0;
                const angleToAttacker = Math.atan2(attacker.y - this.y, attacker.x - this.x);
                if (!this.aimingAt) {
                    this.targetAngle = angleToAttacker;
                    this.isHitReacting = true;
                }
                if (state.bomb.defuser === this) { state.bomb.defuser = null; state.bomb.defuseProgress = 0; this.defuseCooldown = 3.0; document.getElementById('defuse-bar-bg').classList.add('hidden'); }
                if (this.hp <= 0) {
                    this.hp = 0; this.isAlive = false; this.deaths++;
                    
                    if (WEAPONS[this.weapon].isMain) {
                        state.droppedWeapons.push(new DroppedWeapon(this.weapon, this.x, this.y));
                    }

                    if (this.isPlanting) { state.bomb.state = 'idle'; state.bomb.carrier = null; state.bomb.x = this.x; state.bomb.y = this.y; state.bomb.node = this.posNode; this.hasBomb = false; }
                    if (this.hasBomb) { state.bomb.carrier = null; state.bomb.x = this.x; state.bomb.y = this.y; state.bomb.node = this.posNode; this.hasBomb = false; }
                    if (state.bomb.defuser === this) { state.bomb.defuser = null; state.bomb.defuseProgress = 0; document.getElementById('defuse-bar-bg').classList.add('hidden'); }
                    addKillFeed(attacker, this, attacker.weapon, isHS);
                    attacker.kills++; 
                    attacker.money += 200; 
                    checkRoundEnd();
                }
            }

            plantBomb() {
                state.bomb.state = 'planting'; this.isPlanting = true;
                this.broadcastRadio("æ­£åœ¨å®‰æ”¾ç‚¸å¼¹...");
                WeaponSounds.play('c4_initiate'); // å¼€å§‹æ¿€æ´»ç‚¸å¼¹æ—¶æ’­æ”¾
                setTimeout(() => {
                    if (this.isAlive && this.hasBomb && this.isPlanting) {
                        state.bomb.state = 'planted'; state.bomb.x = this.x; state.bomb.y = this.y;
                        state.bomb.node = this.posNode; state.bomb.time = 40;
                        state.bomb.carrier = null; this.hasBomb = false; this.isPlanting = false;
                        this.money += 300; 
                        state.bomb.planter = this; 
                        document.getElementById('timer-container').classList.add('bg-red-900');
                        this.broadcastRadio("ç‚¸å¼¹å·²å®‰æ”¾ï¼");
                        WeaponSounds.play('bomb_plant');
                        // åˆå§‹åŒ–ç‚¸å¼¹æ»´å£°è®¡æ—¶å™¨
                        state.bomb.lastBeep = 0;
                        state.bomb.beepInterval = 800; // åˆå§‹ä¸º0.8ç§’
                        
                        const tAlive = state.players.filter(p => p.isAlive && p.team === 'T');
                        // æ‰¾åˆ°Tæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                        const tCommanders = tAlive.filter(p => p.role === 'Rifle');
                        const tLeader = tCommanders.length > 0 ? tCommanders[0] : tAlive[0];
                        if (tLeader) {
                            if (state.bomb.node === 'aç‚¹') {
                                const smoker = tAlive.find(p => p.utility.flash > 0);
                                if (smoker) {
                                    const loc = Math.random() > 0.5 ? 'è­¦å®¶' : 'aå°ä¸‹';
                                    tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼šä¸‹åŒ…å®Œæˆï¼Œ${smoker.name} ç»™ä¸€é¢— ${loc} é—ªå…‰ï¼`);
                                    smoker.throwFlash(loc);
                                }
                            } else if (state.bomb.node === 'bç‚¹') {
                                if (Math.random() > 0.3) {
                                    const smoker = tAlive.find(p => p.utility.flash > 0);
                                    if (smoker) {
                                        const locs = ['ç‹—æ´', 'bé—¨', 'æ²™åœ°'];
                                        const loc = locs[Math.floor(Math.random() * locs.length)];
                                        tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼šå®ˆåŒ…ï¼Œ${smoker.name} é—ªä¸€ä¸‹ ${loc}ï¼`);
                                        smoker.throwFlash(loc);
                                    }
                                }
                            }
                        }

                        // ä¸‹åŒ…å®Œæˆåï¼ŒæŒ‡æŒ¥ä¼šæ´¾é£ä¸€åŠä»¥ä¸‹çš„é€‰æ‰‹å‰å¾€å…¶ä»–åœ°æ–¹
                        if (tAlive.length > 1) {
                            const playersToSend = Math.floor(tAlive.length / 2);
                            const availablePlayers = [...tAlive];
                            const playersToMove = availablePlayers.sort(() => 0.5 - Math.random()).slice(0, playersToSend);
                            
                            if (state.bomb.node === 'aç‚¹') {
                                // aç‚¹ï¼šaå¤§ã€aå°ã€è­¦å®¶
                                const targets = ['aå¤§', 'aå°ä¸‹', 'è­¦å®¶'];
                                playersToMove.forEach((p, index) => {
                                    const target = targets[index % targets.length];
                                    if (tLeader) { tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${p.name} å‰å¾€ ${target} é˜²å®ˆï¼`); }
                                    p.destination = target;
                                    p.path = findPath(p.posNode, target);
                                    p.pathIdx = 0;
                                });
                            } else if (state.bomb.node === 'bç‚¹') {
                                // bç‚¹ï¼šbé—¨ã€ç‹—æ´ã€bé€š
                                const targets = ['bé—¨', 'ç‹—æ´', 'b2'];
                                playersToMove.forEach((p, index) => {
                                    const target = targets[index % targets.length];
                                    if (tLeader) { tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${p.name} å‰å¾€ ${target} é˜²å®ˆï¼`); }
                                    p.destination = target;
                                    p.path = findPath(p.posNode, target);
                                    p.pathIdx = 0;
                                });
                            }
                        }
                        
                        // å‰©ä½™çš„é€‰æ‰‹ç•™åœ¨åŒ…ç‚¹é˜²å®ˆ
                        const remainingPlayers = state.players.filter(p => p.isAlive && (p.team !== 'T' || !playersToMove || !playersToMove.includes(p)));
                        remainingPlayers.forEach(p => {
                            if (p.team === 'T') {
                                p.destination = this.posNode;
                                p.path = findPath(p.posNode, this.posNode);
                                p.pathIdx = 0;
                                p.tempTarget = null;
                                // æ ‡è®°ä¸ºé˜²å®ˆçŠ¶æ€ï¼Œé¿å…è¢«æˆ˜æœ¯é‡ç»„é€»è¾‘é‡æ–°åˆ†é…ä»»åŠ¡
                                p.isDefending = true;
                            }
                        });
                        
                        // å·²æ´¾é£çš„é€‰æ‰‹ä¹Ÿæ ‡è®°ä¸ºé˜²å®ˆçŠ¶æ€
                        playersToMove.forEach(p => {
                            p.isDefending = true;
                        });
                    }
                }, 3000 / state.speed);
            }

            canSee(other) {
                if (this.blindTimer > 0) return false;
                const dx = other.x - this.x, dy = other.y - this.y;
                const distToEnemy = Math.sqrt(dx*dx + dy*dy);
                if (distToEnemy > this.viewDistance) return false;

                // æ£€æŸ¥ç›®æ ‡ç©å®¶æ˜¯å¦åœ¨çƒŸé›¾ä¸­
                const isEnemyInSmoke = state.smokes.some(s => {
                    if (s.isFlying || s.grenadeEffect > 0) return false;
                    const distToEnemyFromSmoke = Math.sqrt((other.x - s.x)**2 + (other.y - s.y)**2);
                    return distToEnemyFromSmoke < s.radius;
                });
                if (isEnemyInSmoke) return false;

                // æ£€æŸ¥è§†çº¿æ˜¯å¦è¢«çƒŸé›¾é˜»æŒ¡
                const isBlockedBySmoke = state.smokes.some(s => {
                    if (s.isFlying || s.grenadeEffect > 0) return false;
                    const dToLine = distToSegment({x: this.x, y: this.y}, {x: other.x, y: other.y}, {x: s.x, y: s.y});
                    if (dToLine < s.radius) {
                        const distToSmoke = Math.sqrt((this.x - s.x)**2 + (this.y - s.y)**2);
                        if (distToSmoke - distToEnemy > s.radius) return false;
                        return true;
                    }
                    return false;
                });
                if (isBlockedBySmoke) return false;

                const angleTo = Math.atan2(dy, dx);
                return Math.abs(this.normalizeAngle(angleTo - this.angle)) < this.viewAngle/2;
            }

            normalizeAngle(a) { while (a > Math.PI) a -= Math.PI * 2; while (a < -Math.PI) a += Math.PI * 2; return a; }
        }

        function distToSegment(p, v, w) {
            const l2 = (v.x - w.x)**2 + (v.y - w.y)**2;
            if (l2 == 0) return Math.sqrt((p.x - v.x)**2 + (p.y - v.y)**2);
            let t = ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2;
            t = Math.max(0, Math.min(1, t));
            return Math.sqrt((p.x - (v.x + t * (w.x - v.x)))**2 + (p.y - (v.y + t * (w.y - v.y)))**2);
        }

        function toggleRadio() { document.getElementById('radio-window').classList.toggle('-translate-x-[110%]'); }
        function switchRadio(team) {
            state.radioView = team;
            document.getElementById('tab-t').className = `flex-1 py-2 text-[10px] font-bold ${team==='T'?'text-orange-500 border-orange-500':'text-slate-400 border-transparent'} border-b-2 uppercase tracking-tighter`;
            document.getElementById('tab-ct').className = `flex-1 py-2 text-[10px] font-bold ${team==='CT'?'text-blue-500 border-blue-500':'text-slate-400 border-transparent'} border-b-2 uppercase tracking-tighter`;
            updateRadioUI();
        }

        function updateRadioUI() {
            const container = document.getElementById('radio-content'); container.innerHTML = '';
            state.radioHistory[state.radioView].slice().reverse().forEach(m => {
                const el = document.createElement('div'); el.className = `radio-msg bg-white/5`;
                el.innerHTML = `<span class="font-bold ${m.team==='T'?'text-orange-400':'text-blue-400'}">${m.sender}:</span> <span class="text-slate-200">${m.text}</span>`;
                container.appendChild(el);
            });
        }

        function addKillFeed(k, v, w, hs) {
            const feed = document.getElementById('kill-feed');
            const el = document.createElement('div');
            
            // ä¿®æ”¹ä¸‹é¢è¿™ä¸€è¡Œï¼šå°† text-[11px] ä¿®æ”¹ä¸ºä½ æƒ³è¦çš„å¤§å°
            el.className = `flex items-center bg-black/80 px-4 py-1 mb-1 border-r-4 ${k.team === 'T' ? 'border-orange-500' : 'border-blue-500'} text-[13px] font-bold`;
            
            const separator = hs ? "" : "";
            
            // å¦‚æœæƒ³è¦æ­¦å™¨åç§°çš„å¤§å°ä¹Ÿè·Ÿç€å˜ï¼Œå¯ä»¥ä¿®æ”¹ä¸‹é¢çš„ text-[9px]
            el.innerHTML = `<span class="${k.team==='T'?'text-orange-400':'text-blue-400'}">${k.name}</span><span class="text-yellow-500 text-[13px] mx-1">${w}${hs?' -ğŸ—£ï¸> ':''}</span><span>${separator}</span><span class="ml-1 ${v.team==='T'?'text-orange-400':'text-blue-400'}">${v.name}</span>`;
            
            feed.prepend(el); 
            setTimeout(() => el.remove(), 5000);
        }

        function getTeamTotalMoney(team) {
            return state.players.filter(p => p.team === team).reduce((sum, p) => {
                let assetsValue = 0;
                if (WEAPONS[p.weapon]) assetsValue += WEAPONS[p.weapon].price;
                if (p.armorType === 'æŠ¤ç”²+å¤´ç›”') assetsValue += 1000;
                else if (p.armorType === 'æŠ¤ç”²') assetsValue += 650;
                assetsValue += (p.utility.smoke * UTILITY_PRICES.smoke);
                assetsValue += (p.utility.fire * UTILITY_PRICES.fire);
                assetsValue += (p.utility.flash * UTILITY_PRICES.flash);
                assetsValue += (p.utility.nade * UTILITY_PRICES.nade);
                if (p.hasKit) assetsValue += 400;
                return sum + p.money + assetsValue;
            }, 0);
        }

        function initRound() {
            state.time = 115; state.tracers = []; state.smokes = []; state.flashes = []; state.molotovs = []; state.grenades = []; state.droppedWeapons = []; state.isRoundEnded = false; state.lastTacticCheck = 0; state.lastSmokeCheck = 0; state.lastRetakeFlashCheck = 0;
            // æ¸…ç©ºåœºä¸Šæ‰€æœ‰ç‚¸å¼¹ï¼Œå–æ¶ˆç‚¸å¼¹å€’è®¡æ—¶
            state.bomb = { state: 'idle', carrier: null, x: MAP_NODES['åŒªå®¶'].x, y: MAP_NODES['åŒªå®¶'].y, node: 'åŒªå®¶', time: 40, defuser: null, defuseProgress: 0, planter: null };
            document.getElementById('timer-container').className = 'px-8 py-1 flex flex-col items-center justify-center bg-slate-900 min-w-[140px] transition-colors duration-500';
            document.getElementById('defuse-bar-bg').classList.add('hidden');
            document.getElementById('victory-banner').style.display = 'none';
            
            // é‡ç½®å¼€å±€ç‡ƒçƒ§ç“¶æŒ‡ä»¤æ ‡å¿—
            state.hasReleasedStartMolotov = false;
            // é‡ç½®CTå¼€å±€b2ç«æŒ‡ä»¤æ ‡å¿—
            state.hasReleasedCTB2Fire = false;
            // é‡ç½®Tæ–¹å¼€å±€ä¸¢é›·æŒ‡ä»¤æ ‡å¿—
            state.hasReleasedStartNade = false;
            // é‡ç½®è¿›æ”»a/bç‚¹æ‰”ç«æŒ‡ä»¤çš„å†·å´æ—¶é—´
            state.lastAttackMolotovTime = { a: 0, b: 0 };
            // é‡ç½®æ‰€æœ‰ç©å®¶çš„é˜²å®ˆçŠ¶æ€
            state.players.forEach(p => {
                p.isDefending = false;
            });
            
            // æ’­æ”¾å›åˆå¼€å§‹éŸ³æ•ˆ
            WeaponSounds.play('round_start');
            
            state.radioHistory.T = [];
            state.radioHistory.CT = [];
            updateRadioUI();

            const prev = state.players; 
            state.players = [];
            let T_NAMES = window.T_NAMES || [{n:'Player1', r:'Rifle'}, {n:'Player2', r:'Rifle'}, {n:'Player3', r:'Rifle'}, {n:'Player4', r:'Rifle'}, {n:'Player5', r:'AWP'}];
            let CT_NAMES = window.CT_NAMES || [{n:'Player6', r:'Rifle'}, {n:'Player7', r:'AWP'}, {n:'Player8', r:'Rifle'}, {n:'Player9', r:'Rifle'}, {n:'Player10', r:'Rifle'}];
            
            // ä¿å­˜å½“å‰é˜Ÿä¼åç§°
            const currentTTeamName = document.getElementById('t-team-name').innerText;
            const currentCTTeamName = document.getElementById('ct-team-name').innerText;
            
            if (state.isSwapped) {
                const temp = T_NAMES; T_NAMES = CT_NAMES; CT_NAMES = temp;
                document.getElementById('t-team-name').innerText = currentCTTeamName;
                document.getElementById('ct-team-name').innerText = currentTTeamName;
                // æ£€æŸ¥æ˜¯å¦ä¸ºå¤§æ¯”åˆ†
                const isBigScore = state.score.t >= 10 || state.score.ct >= 10 || Math.abs(state.score.t - state.score.ct) > 5;
                if (!isBigScore) {
                    document.getElementById('t-score-box').classList.replace('bg-orange-600', 'bg-blue-600');
                    document.getElementById('ct-score-box').classList.replace('bg-blue-600', 'bg-orange-600');
                }
            } else {
                // ä¿æŒå½“å‰é˜Ÿä¼åç§°ä¸å˜
                // æ£€æŸ¥æ˜¯å¦ä¸ºå¤§æ¯”åˆ†
                const isBigScore = state.score.t >= 10 || state.score.ct >= 10 || Math.abs(state.score.t - state.score.ct) > 5;
                if (!isBigScore) {
                    document.getElementById('t-score-box').classList.replace('bg-blue-600', 'bg-orange-600');
                    document.getElementById('ct-score-box').classList.replace('bg-orange-600', 'bg-blue-600');
                }
            }

            T_NAMES.forEach((cfg, i) => { 
                const p = new Player('T', cfg, i); 
                if(prev.length) { 
                    p.kills = prev.find(old => old.name === cfg.n).kills; 
                    p.deaths = prev.find(old => old.name === cfg.n).deaths; 
                    p.money = prev.find(old => old.name === cfg.n).money; 
                    const oldP = prev.find(old => old.name === cfg.n);
                    if(oldP.isAlive && state.round !== 13 && state.round !== 1) {
                        p.weapon = oldP.weapon;
                        p.utility = { ...oldP.utility };
                        p.armorType = oldP.armorType;
                        p.ammo = oldP.ammo;
                    }
                } 
                else { p.money = 800; }
                if (state.round === 1 || state.round === 13) p.money = 800;
                state.players.push(p); 
            });
            CT_NAMES.forEach((cfg, i) => { 
                const p = new Player('CT', cfg, i+5); 
                if(prev.length) { 
                    p.kills = prev.find(old => old.name === cfg.n).kills; 
                    p.deaths = prev.find(old => old.name === cfg.n).deaths; 
                    p.money = prev.find(old => old.name === cfg.n).money; 
                    const oldP = prev.find(old => old.name === cfg.n);
                    if(oldP.isAlive && state.round !== 13 && state.round !== 1) {
                        p.weapon = oldP.weapon;
                        p.utility = { ...oldP.utility };
                        p.armorType = oldP.armorType;
                        p.ammo = oldP.ammo;
                        p.hasKit = oldP.hasKit; 
                    }
                } 
                else { p.money = 800; }
                if (state.round === 1 || state.round === 13) p.money = 800;
                state.players.push(p); 
            });
            
            const carrier = state.players.filter(p=>p.team==='T')[0];
            carrier.hasBomb = true; state.bomb.carrier = carrier;

            // Tæ–¹å›åˆå¼€å§‹ï¼ŒæŒ‡æŒ¥ä¼šå‘½ä»¤ä¸€ä¸ªæœ‰é—ªçš„äººä¸¢aå°ä¸‹é—ªå…‰
            setTimeout(() => {
                // æ‰¾åˆ°Tæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                const tPlayers = state.players.filter(p => p.team === 'T');
                const tCommanders = tPlayers.filter(p => p.role === 'Rifle');
                const tLeader = tCommanders.length > 0 ? tCommanders[0] : tPlayers[0];
                const tPlayersWithFlash = state.players.filter(p => 
                    p.team === 'T' && p.isAlive && p.utility.flash > 0
                );
                
                if (tLeader && tPlayersWithFlash.length > 0) {
                    const flasher = tPlayersWithFlash[Math.floor(Math.random() * tPlayersWithFlash.length)];
                    tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${flasher.name} å‘ aå°ä¸‹ ä¸¢ä¸€é¢—é—ªå…‰ï¼`);
                    
                    // è®©é€‰æ‰‹ä¸¢é—ªå…‰
                    if (flasher.utility.flash > 0) {
                        flasher.utility.flash--;
                        state.flashes.push(new Flash(flasher.team, flasher.x, flasher.y, 'aå°ä¸‹'));
                        flasher.broadcastRadio(`æ”¶åˆ°ï¼Œå‘ aå°ä¸‹ ä¸¢é—ªå…‰ï¼`);
                    }
                }
                
                // CTæ–¹å›åˆå¼€å§‹ï¼ŒæŒ‡æŒ¥ä¼šéšæœºæ´¾1-3ä¸ªæœ‰é—ªçš„äººæ‰”ç»™åŒªå£é—ªã€ä¸­è¿œé—ªã€åèŠ±å›­é—ªã€æš—é“é—ªã€aé—¨é—ªä¸­çš„éšæœº1~5ä¸ª
                const ctPlayers = state.players.filter(p => p.team === 'CT');
                const ctCommanders = ctPlayers.filter(p => p.role === 'Rifle');
                const ctLeader = ctCommanders.length > 0 ? ctCommanders[0] : ctPlayers[0];
                const ctPlayersWithFlash = state.players.filter(p => 
                    p.team === 'CT' && p.isAlive && p.utility.flash > 0
                );
                
                if (ctLeader && ctPlayersWithFlash.length > 0) {
                    // é—ªå…‰ç›®æ ‡ä½ç½®åˆ—è¡¨
                    const flashTargets = ['åŒªå£', 'ä¸­è¿œ', 'åèŠ±å›­', 'æš—é“', 'aé—¨'];
                    // éšæœºé€‰æ‹©1-5ä¸ªç›®æ ‡ä½ç½®
                    const targetCount = Math.floor(Math.random() * 5) + 1;
                    const selectedTargets = flashTargets.sort(() => 0.5 - Math.random()).slice(0, targetCount);
                    // éšæœºé€‰æ‹©1-3ä¸ªæœ‰é—ªçš„äºº
                    const playerCount = Math.min(Math.floor(Math.random() * 3) + 1, ctPlayersWithFlash.length);
                    const selectedPlayers = ctPlayersWithFlash.sort(() => 0.5 - Math.random()).slice(0, playerCount);
                    
                    // åˆ†é…é—ªå…‰ä»»åŠ¡
                    selectedTargets.forEach((target, index) => {
                        const player = selectedPlayers[index % selectedPlayers.length];
                        if (player && player.utility.flash > 0) {
                            ctLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${player.name} å‘ ${target} ä¸¢ä¸€é¢—é—ªå…‰ï¼`);
                            player.utility.flash--;
                            state.flashes.push(new Flash(player.team, player.x, player.y, target));
                            player.broadcastRadio(`æ”¶åˆ°ï¼Œå‘ ${target} ä¸¢é—ªå…‰ï¼`);
                        }
                    });
                }
            }, 1000);

            ['T', 'CT'].forEach(team => {
                const totalMoney = getTeamTotalMoney(team);
                const teamPlayers = state.players.filter(p => p.team === team);
                // æ‰¾åˆ°é˜Ÿä¼çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                const commanders = teamPlayers.filter(p => p.role === 'Rifle');
                const leader = commanders.length > 0 ? commanders[0] : teamPlayers[0];
                let strategy = 'Full';
                let heroPlayer = null;

                if (state.round > 1 && state.round !== 13) {
                    // æ‰‹æªå±€èµ¢äº†ï¼Œä¸‹ä¸€æŠŠå¿…ç„¶å…¨èµ·æˆ–å¼ºèµ·
                    const isPistolWin = (state.round === 2 || state.round === 14);
                    if (isPistolWin) {
                        const rand = Math.random();
                        if (rand < 0.7) strategy = 'Full';
                        else strategy = 'Force';
                    } else if (totalMoney < 15000) { 
                        const rand = Math.random();
                        if (rand < 0.4) strategy = 'Eco';
                        else if (rand < 0.8) strategy = 'Force';
                        else { strategy = 'Hero'; heroPlayer = [...teamPlayers].sort((a,b) => b.money - a.money)[0]; }
                    } else if (totalMoney <= 25000) {
                        strategy = Math.random() < 0.5 ? 'Half' : 'Full';
                    } else { strategy = 'Full'; }
                    const strategyNames = { 'Eco': 'ECO (çº¯ç»æµå±€)', 'Force': 'FORCE BUY (å¼ºèµ·å±€)', 'Hero': 'HERO WEAPON (è‹±é›„æª)', 'Half': 'HALF BUY (åŠèµ·å±€)', 'Full': 'FULL BUY (å…¨èµ·å±€)' };
                    if (leader) leader.broadcastRadio(`æŒ‡æŒ¥ï¼šæœ¬å±€ç­–ç•¥ - ${strategyNames[strategy]}ï¼`);
                }
                teamPlayers.forEach(p => p.buy(strategy, p === heroPlayer));

                if (team === 'T') {
                    // æ‰¾åˆ°Tæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                    const tCommanders = teamPlayers.filter(p => p.role === 'Rifle');
                    const tLeader = tCommanders.length > 0 ? tCommanders[0] : teamPlayers[0];
                    if (tLeader) {
                        const smoker = teamPlayers.find(p => p.utility.smoke > 0);
                        if (smoker) {
                            tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${smoker.name}ï¼Œå¼€å±€ç»™ä¸€é¢—ä¸­é—¨çƒŸå°é”è§†çº¿ï¼`);
                            smoker.throwSmoke('ä¸­é—¨');
                        }
                    }
                }
            });

            updateHUD();
        }

        function checkRoundEnd() {
            if (state.isRoundEnded) return;
            const tAlive = state.players.filter(p => p.team === 'T' && p.isAlive).length;
            const ctAlive = state.players.filter(p => p.team === 'CT' && p.isAlive).length;
            if (ctAlive === 0) endRound('T', 'COUNTER-TERRORISTS ELIMINATED');
            else if (tAlive === 0 && state.bomb.state !== 'planted') endRound('CT', 'TERRORISTS ELIMINATED');
        }

        function endRound(winner, reason) {
            if (state.isRoundEnded) return;
            
            // å–æ¶ˆä»»ä½•æ­£åœ¨è¿›è¡Œçš„ç‚¸å¼¹å®‰è£…æ“ä½œ
            state.players.forEach(p => {
                if (p.isPlanting) {
                    p.isPlanting = false;
                    state.bomb.state = 'idle';
                    state.bomb.carrier = null;
                    p.hasBomb = false;
                }
            });
            
            state.isRoundEnded = true; 
            state.score[winner.toLowerCase()]++;
            state.round++;
            
            // æ’­æ”¾èƒœåˆ©éŸ³æ•ˆï¼ˆç‚¸å¼¹æ‹†é™¤æ—¶ä¸æ’­æ”¾CTèƒœåˆ©éŸ³æ•ˆï¼Œå› ä¸ºå·²ç»æ’­æ”¾äº†ç‚¸å¼¹æ‹†é™¤éŸ³æ•ˆï¼‰
            if (reason !== 'BOMB DEFUSED') {
                if (winner === 'T') {
                    WeaponSounds.play('t_win');
                } else if (winner === 'CT') {
                    WeaponSounds.play('ct_win');
                }
            }
            
            // è®¡ç®—é‡‘é’±è¡¥å¿
            let tBonus = 1400; let ctBonus = 1400;
            if (winner === 'CT') {
                // CTèƒœåˆ©
                if (reason === 'BOMB DEFUSED') ctBonus = 3500;
                else if (reason === 'TERRORISTS ELIMINATED') ctBonus = 3250;
                else if (reason === 'TIME EXPIRED') ctBonus = 3250;
                
                // Tè´¥æ–¹è¡¥å¿
                state.consecutiveLosses.T = Math.min(state.consecutiveLosses.T + 1, 4);
                tBonus = 1400 + (state.consecutiveLosses.T * 500);
                tBonus = Math.min(tBonus, 3400);
                
                // CTèƒœåˆ©ï¼Œå‡å°‘è¿è´¥æ•°
                state.consecutiveLosses.CT = Math.max(state.consecutiveLosses.CT - 2, 0);
            } else {
                // Tèƒœåˆ©
                if (reason === 'BOMB EXPLODED') tBonus = 3500;
                else if (reason === 'COUNTER-TERRORISTS ELIMINATED') tBonus = 3250;
                
                // CTè´¥æ–¹è¡¥å¿
                state.consecutiveLosses.CT = Math.min(state.consecutiveLosses.CT + 1, 4);
                ctBonus = 1400 + (state.consecutiveLosses.CT * 500);
                ctBonus = Math.min(ctBonus, 3400);
                
                // Tèƒœåˆ©ï¼Œå‡å°‘è¿è´¥æ•°
                state.consecutiveLosses.T = Math.max(state.consecutiveLosses.T - 2, 0);
            }
            state.players.forEach(p => {
                if (p.team === 'T') p.money = Math.min(16000, p.money + tBonus);
                else p.money = Math.min(16000, p.money + ctBonus);
            });

            let finalWinner = null;
            const tTeamName = document.getElementById('t-team-name').innerText;
            const ctTeamName = document.getElementById('ct-team-name').innerText;
            if (state.score.t >= state.winTarget && state.score.t - state.score.ct >= 1) finalWinner = state.isSwapped ? ctTeamName.toUpperCase() : tTeamName.toUpperCase();
            if (state.score.ct >= state.winTarget && state.score.ct - state.score.t >= 1) finalWinner = state.isSwapped ? tTeamName.toUpperCase() : ctTeamName.toUpperCase();

            if (state.score.t === state.winTarget - 1 && state.score.ct === state.winTarget - 1) {
                state.winTarget += 3; 
            }

            if (finalWinner) {
                const banner = document.getElementById('victory-banner');
                const inner = document.getElementById('victory-inner');
                inner.innerText = `${finalWinner} IS THE CHAMPION!`;
                inner.style.color = "gold";
                banner.style.display = 'block';
                state.running = false;
                return;
            }

            if (state.round === 13) {
                state.isSwapped = !state.isSwapped;
                const tempScore = state.score.t; state.score.t = state.score.ct; state.score.ct = tempScore;
            }

            const banner = document.getElementById('victory-banner');
            const inner = document.getElementById('victory-inner');
            inner.innerText = winner === 'T' ? 'TERRORISTS WIN' : 'COUNTER-TERRORISTS WIN';
            inner.style.color = winner === 'T' ? '#f97316' : '#3b82f6';
            banner.style.display = 'block';
            
            // ç­‰å¾…5ç§’åè¿›å…¥ä¸‹ä¸€å±€ï¼Œä¸å½±å“å…¶ä»–äººçš„æ­£å¸¸æ´»åŠ¨
            setTimeout(() => {
                if(state.running) {
                    initRound();
                }
            }, 5000);
        }

    function handleTacticalSmokes(dt) {
            if (state.isRoundEnded) return;
            state.lastSmokeCheck += dt * state.speed;
            if (state.lastSmokeCheck >= 30.0) {
                state.lastSmokeCheck = 0;
                
                // è·å– CT é˜µè¥å­˜æ´»é€‰æ‰‹
                const ctAlive = state.players.filter(p => p.isAlive && p.team === 'CT');
                // è·å–å¯¹æ‰‹ï¼ˆT é˜µè¥ï¼‰å­˜æ´»äººæ•°
                const tAliveCount = state.players.filter(p => p.isAlive && p.team === 'T').length;
                // è·å–CTæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                const ctCommanders = ctAlive.filter(p => p.role === 'Rifle');
                const ctLeader = ctCommanders.length > 0 ? ctCommanders[0] : ctAlive[0];

                // åªæœ‰å½“æŒ‡æŒ¥å®˜åœ¨åœºã€CT æœ‰äººå­˜æ´»ã€ä¸” T é˜µè¥ä¹Ÿæœ‰äººå­˜æ´»æ—¶æ‰ä¸¢é“å…·
                if (ctLeader && ctAlive.length > 0 && tAliveCount > 0) {
                    const potentialNodes = ['aé—¨', 'aå°ä¸‹', 'b2'];
                    const count = Math.floor(Math.random() * 3) + 1; 
                    const selectedNodes = potentialNodes.sort(() => 0.5 - Math.random()).slice(0, count);
                    
                    selectedNodes.forEach(node => {
                        const smoker = ctAlive.find(p => p.utility.smoke > 0);
                        if (smoker) { 
                            smoker.throwSmoke(node); 
                        }
                    });
                }
            }
        }

        function handleMolotovThrows(dt) {
            if (state.isRoundEnded) return;
            
            // è·å–ä¸¤é˜Ÿå­˜æ´»æƒ…å†µ
            const tAlive = state.players.filter(p => p.isAlive && p.team === 'T');
            const ctAlive = state.players.filter(p => p.isAlive && p.team === 'CT');
            
            // è·å–æŒ‡æŒ¥å®˜ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
            const tCommanders = tAlive.filter(p => p.role === 'Rifle');
            const ctCommanders = ctAlive.filter(p => p.role === 'Rifle');
            const tLeader = tCommanders.length > 0 ? tCommanders[0] : tAlive[0];
            const ctLeader = ctCommanders.length > 0 ? ctCommanders[0] : ctAlive[0];
            
            // æ£€æŸ¥æŒ‡å®šç‚¹ä½æ˜¯å¦å·²æœ‰ç‡ƒçƒ§ç“¶
            function isNodeHasMolotov(node) {
                return state.molotovs.some(m => {
                    if (!m.exploded) return false;
                    const nodeDist = Math.sqrt((MAP_NODES[node].x - m.x)**2 + (MAP_NODES[node].y - m.y)**2);
                    return nodeDist < 100 && m.life > 0;
                });
            }
            
            // æ£€æŸ¥æŒ‡å®šç‚¹ä½æ˜¯å¦æœ‰é˜Ÿå‹åœç•™
            function isNodeHasTeammate(node, team) {
                return state.players.some(p => {
                    if (!p.isAlive || p.team !== team) return false;
                    const nodeDist = Math.sqrt((MAP_NODES[node].x - p.x)**2 + (MAP_NODES[node].y - p.y)**2);
                    return nodeDist < 100;
                });
            }
            
            // Tæ–¹é€»è¾‘
            if (tLeader && tAlive.length > 0) {
                // å›åˆå¼€å§‹åçš„5sï¼Œå‘aå°æ‰”ç‡ƒçƒ§ç“¶ï¼ˆæ¯å±€åªå‘å¸ƒä¸€æ¬¡æŒ‡ä»¤ï¼‰
                if (state.time >= 110 && state.time < 115 && !state.hasReleasedStartMolotov) {
                    if (Math.random() < 0.6 && !isNodeHasMolotov('aå°ä¸‹') && !isNodeHasTeammate('aå°ä¸‹', 'T')) {
                        const molotovPlayer = tAlive.find(p => p.utility.fire > 0);
                        if (molotovPlayer) {
                            tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${molotovPlayer.name} å‘ aå°ä¸‹ æ‰”ç‡ƒçƒ§ç“¶ï¼`);
                            molotovPlayer.throwMolotov('aå°ä¸‹');
                            state.hasReleasedStartMolotov = true; // æ ‡è®°å·²ç»å‘å¸ƒäº†æŒ‡ä»¤
                        }
                    }
                }
                
                // è¿›æ”»aç‚¹æ—¶ï¼Œå‘aç‚¹æ‰”ç«
                if (tAlive.some(p => p.destination === 'aç‚¹')) {
                    const currentTime = 115 - state.time;
                    if (Math.random() < 0.6 && !isNodeHasMolotov('aç‚¹') && !isNodeHasTeammate('aç‚¹', 'T') && currentTime - state.lastAttackMolotovTime.a >= 10) {
                        const molotovPlayer = tAlive.find(p => p.utility.fire > 0);
                        if (molotovPlayer) {
                            tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${molotovPlayer.name} å‘ aç‚¹ æ‰”ç‡ƒçƒ§ç“¶ï¼`);
                            molotovPlayer.throwMolotov('aç‚¹');
                            state.lastAttackMolotovTime.a = currentTime;
                        }
                    }
                }
                
                // è¿›æ”»bç‚¹æ—¶ï¼Œå‘bç‚¹æ‰”ç«
                if (tAlive.some(p => p.destination === 'bç‚¹')) {
                    const currentTime = 115 - state.time;
                    if (Math.random() < 0.5 && !isNodeHasMolotov('bç‚¹') && !isNodeHasTeammate('bç‚¹', 'T') && currentTime - state.lastAttackMolotovTime.b >= 10) {
                        const molotovPlayer = tAlive.find(p => p.utility.fire > 0);
                        if (molotovPlayer) {
                            tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${molotovPlayer.name} å‘ bç‚¹ æ‰”ç‡ƒçƒ§ç“¶ï¼`);
                            molotovPlayer.throwMolotov('bç‚¹');
                            state.lastAttackMolotovTime.b = currentTime;
                        }
                    }
                }
                
                // ä¸‹åŒ…å®Œæˆåçš„5s
                if (state.bomb.state === 'planted' && state.bomb.time >= 35 && state.bomb.time < 40) {
                    if (state.bomb.node === 'aç‚¹') {
                        // å‘aå¤§ã€æ²™åœ°å’Œaå°æ‰”ç«
                        if (Math.random() < 0.6) {
                            const targets = ['aå¤§', 'æ²™åœ°', 'aå°ä¸‹'];
                            // è¿‡æ»¤æ‰å·²æœ‰ç‡ƒçƒ§ç“¶æˆ–æœ‰é˜Ÿå‹çš„ç›®æ ‡
                            const availableTargets = targets.filter(target => !isNodeHasMolotov(target) && !isNodeHasTeammate(target, 'T'));
                            if (availableTargets.length > 0) {
                                const target = availableTargets[Math.floor(Math.random() * availableTargets.length)];
                                const molotovPlayer = tAlive.find(p => p.utility.fire > 0);
                                if (molotovPlayer) {
                                    tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${molotovPlayer.name} å‘ ${target} æ‰”ç‡ƒçƒ§ç“¶ï¼`);
                                    molotovPlayer.throwMolotov(target);
                                }
                            }
                        }
                    } else if (state.bomb.node === 'bç‚¹') {
                        // å‘bé—¨æ‰”ç«
                        if (Math.random() < 0.7 && !isNodeHasMolotov('bé—¨') && !isNodeHasTeammate('bé—¨', 'T')) {
                            const molotovPlayer = tAlive.find(p => p.utility.fire > 0);
                            if (molotovPlayer) {
                                tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${molotovPlayer.name} å‘ bé—¨ æ‰”ç‡ƒçƒ§ç“¶ï¼`);
                                molotovPlayer.throwMolotov('bé—¨');
                            }
                        }
                        // å‘ç‹—æ´æ‰”ç«
                        if (Math.random() < 0.7 && !isNodeHasMolotov('ç‹—æ´') && !isNodeHasTeammate('ç‹—æ´', 'T')) {
                            const molotovPlayer = tAlive.find(p => p.utility.fire > 0);
                            if (molotovPlayer) {
                                tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${molotovPlayer.name} å‘ ç‹—æ´ æ‰”ç‡ƒçƒ§ç“¶ï¼`);
                                molotovPlayer.throwMolotov('ç‹—æ´');
                            }
                        }
                    }
                }
            }
            
            // CTæ–¹é€»è¾‘
            if (ctLeader && ctAlive.length > 0) {
                // å›åˆå¼€å§‹å5sï¼ˆæ¯å±€åªå‘å¸ƒä¸€æ¬¡æŒ‡ä»¤ï¼‰
                if (state.time >= 110 && state.time < 115 && !state.hasReleasedStartMolotov) {
                    // å‘aé—¨æ‰”ç‡ƒçƒ§ç“¶
                    if (Math.random() < 0.7 && !isNodeHasMolotov('aé—¨') && !isNodeHasTeammate('aé—¨', 'CT')) {
                        const molotovPlayer = ctAlive.find(p => p.utility.fire > 0);
                        if (molotovPlayer) {
                            ctLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${molotovPlayer.name} å‘ aé—¨ æ‰”ç‡ƒçƒ§ç“¶ï¼`);
                            molotovPlayer.throwMolotov('aé—¨');
                            state.hasReleasedStartMolotov = true; // æ ‡è®°å·²ç»å‘å¸ƒäº†æŒ‡ä»¤
                        }
                    }
                    // å‘åŒªå£æˆ–è€…ä¸­è¿œæ‰”ç‡ƒçƒ§ç“¶
                    if (Math.random() < 0.4 && !state.hasReleasedStartMolotov) {
                        const target = Math.random() > 0.5 ? 'åŒªå£' : 'ä¸­è¿œ';
                        if (!isNodeHasMolotov(target) && !isNodeHasTeammate(target, 'CT')) {
                            const molotovPlayer = ctAlive.find(p => p.utility.fire > 0);
                            if (molotovPlayer) {
                                ctLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${molotovPlayer.name} å‘ ${target} æ‰”ç‡ƒçƒ§ç“¶ï¼`);
                                molotovPlayer.throwMolotov(target);
                                state.hasReleasedStartMolotov = true; // æ ‡è®°å·²ç»å‘å¸ƒäº†æŒ‡ä»¤
                            }
                        }
                    }
                    // å‘b2æ‰”ç‡ƒçƒ§ç“¶
                    if (Math.random() < 0.7 && !isNodeHasMolotov('b2') && !state.hasReleasedStartMolotov && !isNodeHasTeammate('b2', 'CT')) {
                        const molotovPlayer = ctAlive.find(p => p.utility.fire > 0);
                        if (molotovPlayer) {
                            ctLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${molotovPlayer.name} å‘ b2 æ‰”ç‡ƒçƒ§ç“¶ï¼`);
                            molotovPlayer.throwMolotov('b2');
                            state.hasReleasedStartMolotov = true; // æ ‡è®°å·²ç»å‘å¸ƒäº†æŒ‡ä»¤
                        }
                    }
                }
                
                // è‹¥aç‚¹å·²ç»ä¸‹åŒ…ï¼Œå‘aç‚¹æ‰”ç«
                if (state.bomb.state === 'planted' && state.bomb.node === 'aç‚¹') {
                    if (Math.random() < 0.6 && !isNodeHasMolotov('aç‚¹') && !isNodeHasTeammate('aç‚¹', 'CT')) {
                        const molotovPlayer = ctAlive.find(p => p.utility.fire > 0);
                        if (molotovPlayer) {
                            ctLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${molotovPlayer.name} å‘ aç‚¹ æ‰”ç‡ƒçƒ§ç“¶ï¼`);
                            molotovPlayer.throwMolotov('aç‚¹');
                        }
                    }
                }
                
                // è‹¥bç‚¹å·²ç»ä¸‹åŒ…ï¼Œå‘bç‚¹æ‰”ç«
                if (state.bomb.state === 'planted' && state.bomb.node === 'bç‚¹') {
                    if (Math.random() < 0.6 && !isNodeHasMolotov('bç‚¹') && !isNodeHasTeammate('bç‚¹', 'CT')) {
                        const molotovPlayer = ctAlive.find(p => p.utility.fire > 0);
                        if (molotovPlayer) {
                            ctLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${molotovPlayer.name} å‘ bç‚¹ æ‰”ç‡ƒçƒ§ç“¶ï¼`);
                            molotovPlayer.throwMolotov('bç‚¹');
                        }
                    }
                }
            }
        }

        function checkReorganizeTactics(dt) {
            if (state.isRoundEnded) return;

            // é¢„å…ˆè·å–ä¸¤é˜Ÿå­˜æ´»æƒ…å†µï¼Œç”¨äºåç»­åˆ¤æ–­
            const tAlive = state.players.filter(p => p.isAlive && p.team === 'T');
            const ctAlive = state.players.filter(p => p.isAlive && p.team === 'CT');
            if (state.bomb.state !== 'planted' && ctAlive.length > 0 && ctAlive.every(p => p.isIdle())) {
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¸€ä¸ªç‚¹æ˜¯æ— äººçš„
                const aPointPlayers = ctAlive.filter(p => p.posNode === 'aç‚¹');
                const bPointPlayers = ctAlive.filter(p => p.posNode === 'bç‚¹');
                const hasEmptySite = aPointPlayers.length === 0 || bPointPlayers.length === 0;
                
                if (hasEmptySite) {
                    // æŒ‡æŒ¥ä¼šå‘½ä»¤ä¸€åŠçš„äººå®ˆaç‚¹ï¼Œä¸€åŠçš„äººå®ˆbç‚¹
                    ctAlive.forEach((p, idx) => {
                        const targetSite = idx < Math.ceil(ctAlive.length / 2) ? 'aç‚¹' : 'bç‚¹';
                        p.destination = targetSite;
                        p.path = findPath(p.posNode, targetSite);
                        p.pathIdx = 0;
                        // å®ˆç‚¹é€‰æ‰‹çš„çŠ¶æ€ä¹Ÿè¢«è§†ä¸ºç©ºé—²ï¼Œå³è§†è§’æœå‘ä»»æ„æ¥è·¯
                        // ä¸éœ€è¦ç‰¹æ®Šæ ‡è®°ï¼Œå› ä¸ºåˆ°è¾¾ç›®æ ‡ç‚¹åï¼Œä»–ä»¬ä¼šè¿›å…¥ç©ºé—²çŠ¶æ€
                        // ç©ºé—²çŠ¶æ€ä¸‹ï¼ŒmoveAlongPathæ–¹æ³•ä¼šè‡ªåŠ¨å¤„ç†è§†è§’æœå‘ä»»æ„æ¥è·¯
                    });
                }
            }

            // --- æƒ…å†µ 1ï¼šC4 å·²å®‰æ”¾ï¼ˆå¤„ç† CT å›é˜²é“å…·å’Œç§»åŠ¨ï¼‰ ---
            if (state.bomb.state === 'planted') {
                state.lastRetakeFlashCheck += dt * state.speed;
                if (state.lastRetakeFlashCheck >= 5.0) {
                    state.lastRetakeFlashCheck = 0;
                    // æ‰¾åˆ°CTæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                    const ctCommanders = ctAlive.filter(p => p.role === 'Rifle');
                    const ctLeader = ctCommanders.length > 0 ? ctCommanders[0] : ctAlive[0];
                    const flasher = state.players.find(p => p.isAlive && p.team === 'CT' && p.utility.flash > 0);
                    
                    // åªæœ‰å½“æŒ‡æŒ¥å®˜åœ¨åœºã€æœ‰ CT å­˜æ´»ä¸”èƒ½ä¸¢é—ªï¼Œå¹¶ä¸” T é˜µè¥æœ‰äººæ´»ç€å®ˆåŒ…æ—¶æ‰ä¸¢
                    if (ctLeader && flasher && tAlive.length > 0) { 
                        flasher.throwFlash(state.bomb.node); 
                    }
                }
                
                // CT å›é˜²é€»è¾‘ï¼šæ‰€æœ‰å­˜æ´»çš„ CT é˜Ÿå‘˜éƒ½åº”è¯¥å‰å¾€ç‚¸å¼¹ä½ç½®
                if (ctAlive.length > 0) {
                    // æ‰¾åˆ°CTæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                    const ctCommanders = ctAlive.filter(p => p.role === 'Rifle');
                    const ctLeader = ctCommanders.length > 0 ? ctCommanders[0] : ctAlive[0];
                    ctAlive.forEach(p => {
                        if (p.destination !== state.bomb.node) {
                            p.destination = state.bomb.node;
                            p.path = findPath(p.posNode, state.bomb.node);
                            p.pathIdx = 0;
                            if (ctLeader) {
                                ctLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${p.name} å›é˜² ${state.bomb.node}ï¼`);
                            }
                        }
                    });
                }
                
                // æ‹†åŒ…æ—¶ T é˜Ÿå›é˜²é€»è¾‘ï¼šå½“æœ‰äººå¼€å§‹æ‹†åŒ…æ—¶ï¼Œæ‰€æœ‰å­˜æ´»çš„ T é˜Ÿé˜Ÿå‘˜éƒ½åº”è¯¥è¿”å›åŒ…ç‚¹
                if (state.bomb.defuser) {
                    // æ‰¾åˆ°Tæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                    const tCommanders = tAlive.filter(p => p.role === 'Rifle');
                    const tLeader = tCommanders.length > 0 ? tCommanders[0] : tAlive[0];
                    tAlive.forEach(p => {
                        if (p.destination !== state.bomb.node) {
                            p.destination = state.bomb.node;
                            p.path = findPath(p.posNode, state.bomb.node);
                            p.pathIdx = 0;
                            if (tLeader) {
                                tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼šæœ‰äººåœ¨æ‹†åŒ…ï¼${p.name} ç«‹å³å›é˜² ${state.bomb.node}ï¼`);
                            }
                        }
                    });
                }
            }
            
            // --- æƒ…å†µ 2ï¼šæˆ˜æœ¯é‡ç»„ä¸è¿›æ”»ï¼ˆæ¯ 5 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰ ---
            state.lastTacticCheck += dt * state.speed;
            if (state.lastTacticCheck >= 5.0) {
                state.lastTacticCheck = 0;
                
                // å¦‚æœåŒ…å·²ç»è½ä½ï¼Œä¸å†æ‰§è¡Œæœ¬æ®µé€»è¾‘ï¼ˆåŒ…å·²å®‰æ”¾é€»è¾‘åœ¨ä¸Šæ–¹å¤„ç†ï¼‰
                if (state.bomb.state === 'planted') return;
                
                // æ‰¾åˆ°Tæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                const tCommanders = tAlive.filter(p => p.role === 'Rifle');
                const tLeader = tCommanders.length > 0 ? tCommanders[0] : tAlive[0];
                if (tAlive.length === 0 || !tLeader) return;

                // 2a. å¦‚æœåŒ…æ‰åœ°ä¸Šäº†ï¼ŒæŒ‡æ´¾æœ€è¿‘çš„ T å»æ¡åŒ…ï¼ˆè¿™å±äºåŸºç¡€é€»è¾‘ï¼Œä¸ä¾èµ–æ•Œäººæ˜¯å¦å­˜æ´»ï¼‰
                if (state.bomb.state === 'idle' && !state.bomb.carrier) {
                    let nearestPlayer = null; let minDist = Infinity;
                    tAlive.forEach(p => {
                        const d = Math.sqrt((p.x - state.bomb.x)**2 + (p.y - state.bomb.y)**2);
                        if (d < minDist) { minDist = d; nearestPlayer = p; }
                    });
                    if (nearestPlayer && !nearestPlayer.tempTarget) {
                        nearestPlayer.path = findPath(nearestPlayer.posNode, state.bomb.node);
                        nearestPlayer.pathIdx = 0; nearestPlayer.tempTarget = { x: state.bomb.x, y: state.bomb.y };
                    }
                } 
                // 2b. T é˜µè¥å…¨å‘˜å¤„äºç©ºé—²ï¼ˆå‡†å¤‡ç»„ç»‡ä¸‹ä¸€æ³¢è¿›æ”»ï¼‰
                else {
                    // æ’é™¤æ­£åœ¨é˜²å®ˆçš„é˜Ÿå‘˜
                    const nonDefendingTAlive = tAlive.filter(p => !p.isDefending);
                    if (nonDefendingTAlive.length > 0 && nonDefendingTAlive.every(p => p.isIdle())) {
                    const targetSite = Math.random() > 0.5 ? 'aç‚¹' : 'bç‚¹';
                    
                    // ä¿®æ­£ï¼šåªæœ‰å½“ CT é˜µè¥æœ‰äººå­˜æ´»ï¼ˆæœ‰äººé˜²å®ˆï¼‰æ—¶ï¼ŒT é˜µè¥æ‰ä¸¢çƒŸé›¾å¹²æ‰°
                    if (ctAlive.length > 0) {
                        let smokers = tAlive.filter(p => p.utility.smoke > 0);
                        if (targetSite === 'bç‚¹') {
                            if (smokers[0]) smokers[0].throwSmoke('bé—¨');
                            if (smokers[1]) smokers[1].throwSmoke('ç‹—æ´');
                        } else {
                            if (smokers[0]) smokers[0].throwSmoke('è­¦å®¶');
                            if (smokers[1]) smokers[1].throwSmoke('aå°ä¸‹');
                        }
                    }
                    
                    // æ— è®ºæœ‰æ²¡æœ‰æ•Œäººï¼ŒT é˜µè¥åœ¨ç©ºé—²æ—¶éƒ½éœ€è¦å‘åŒ…ç‚¹ç§»åŠ¨ï¼ˆä¸ºäº†åŸ‹åŒ…ï¼‰
                    nonDefendingTAlive.forEach(p => { 
                        p.destination = targetSite; 
                        p.path = findPath(p.posNode, targetSite); 
                        p.pathIdx = 0; 
                    });
                }
                }
            }
        }

        function draw() {
            ctx.clearRect(0,0,1000,700);
            ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 20; ctx.lineCap='round';
            Object.values(MAP_NODES).forEach(n => n.links.forEach(l => { ctx.beginPath(); ctx.moveTo(n.x, n.y); ctx.lineTo(MAP_NODES[l].x, MAP_NODES[l].y); ctx.stroke(); }));
            Object.keys(MAP_NODES).forEach(key => {
                const node = MAP_NODES[key];
                if (node.type === 'site') { ctx.save(); ctx.setLineDash([5, 5]); ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(node.x, node.y, 40, 0, Math.PI * 2); ctx.stroke(); ctx.restore(); }
                ctx.fillStyle = 'white'; ctx.font = '10px Roboto Mono'; ctx.textAlign = 'center'; ctx.fillText(key.toUpperCase(), node.x, node.y + 25);
            });

            state.droppedWeapons.forEach(dw => dw.draw(ctx));

            if (state.bomb.state === 'idle' && !state.bomb.carrier) { ctx.fillStyle = '#ef4444'; ctx.fillRect(state.bomb.x-8, state.bomb.y-8, 16, 16); }
            else if (state.bomb.state === 'planted') { ctx.fillStyle = '#ef4444'; ctx.fillRect(state.bomb.x-10, state.bomb.y-5, 20, 10); }
            
            state.smokes.forEach(s => s.draw(ctx));
            state.flashes.forEach(f => f.draw(ctx));
            if (state.molotovs) {
                state.molotovs.forEach(m => m.draw(ctx));
            }
            state.tracers.forEach((t, i) => { ctx.strokeStyle = `rgba(255, 255, 120, ${t.life * 10})`; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(t.x1, t.y1); ctx.lineTo(t.x2, t.y2); ctx.stroke(); t.life -= 0.01 * state.speed; if(t.life <= 0) state.tracers.splice(i, 1); });
            
            // ç»˜åˆ¶å¼€ç«ç‰¹æ•ˆ
            if (state.fireEffects) {
                state.fireEffects.forEach(effect => {
                    ctx.save();
                    ctx.globalAlpha = effect.life * 10;
                    ctx.fillStyle = 'orange';
                    ctx.beginPath();
                    ctx.arc(effect.x, effect.y, effect.size * effect.life * 10, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'yellow';
                    ctx.beginPath();
                    ctx.arc(effect.x, effect.y, effect.size * 0.5 * effect.life * 10, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });
            }
            
            state.players.forEach(p => {
                if (!p.isAlive) return;
                ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle);
                if (p.blindTimer <= 0) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.05)'; ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0, p.viewDistance, -p.viewAngle/2, p.viewAngle/2); ctx.closePath(); ctx.fill();
                }
                ctx.restore();
                let baseColor = p.team === 'T' ? [249, 115, 22] : [59, 130, 246];
                let colorStr = p.blindTimer > 0 ? `rgb(255,255,255)` : `rgb(${baseColor[0]},${baseColor[1]},${baseColor[2]})`;
                ctx.fillStyle = p.hitFlash > 0 ? `rgba(255,0,0,${p.hitFlash})` : colorStr;
                ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = 'white'; ctx.lineWidth = 1.5; ctx.stroke();
                if(p.hasBomb) { ctx.fillStyle='red'; ctx.fillRect(p.x-4,p.y-4,8,8); }
                ctx.fillStyle = 'white'; ctx.font = 'bold 9px Oswald'; ctx.textAlign = 'center'; ctx.fillText(p.name, p.x, p.y - 15);
            });
            
            // ç»˜åˆ¶æ‰‹é›·å’Œçˆ†ç‚¸ç‰¹æ•ˆåœ¨æœ€é¡¶å±‚
            if (state.grenades) {
                state.grenades.forEach(g => g.draw(ctx));
            }
        }

        function updateHUD() {
            const tH = document.getElementById('t-hud'), ctH = document.getElementById('ct-hud');
            tH.innerHTML = ''; ctH.innerHTML = '';
            state.players.forEach(p => {
                const card = document.createElement('div');
                
                // è®¡ç®—è¡€é‡ç™¾åˆ†æ¯”
                const hpPercent = Math.ceil(p.hp);
                // æ ¹æ®é˜µè¥å†³å®šé¢œè‰²
                const teamColor = p.team === 'T' ? '#f97316' : '#3b82f6'; 
                
                // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ linear-gradient å°†èƒŒæ™¯åšæˆè¡€é‡æ¡
                // ä»å·¦åˆ°å³ï¼šteamColor å æ® hpPercent çš„ä½ç½®ï¼Œå‰©ä½™éƒ¨åˆ†ä¸ºé»‘è‰²(rgba(0,0,0,0.8))
                card.style.background = `linear-gradient(to right, ${teamColor}99 ${hpPercent}%, rgba(0,0,0,0.8) ${hpPercent}%)`;
                
                card.className = `border-l-4 ${p.team==='T'?'border-orange-500':'border-blue-500'} px-3 py-1 flex flex-col justify-center gap-1 shadow-lg transition-all duration-300 ${!p.isAlive?'opacity-20 translate-y-1 grayscale':''}`;
                
                let extra = p.hasBomb ? `<span class="bg-red-600 px-1 rounded text-[10px] ml-2">BOMB</span>` : "";
                if(p.hasKit) extra += `<span class="bg-blue-600 px-1 rounded text-[10px] ml-2">KIT</span>`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-center relative z-10">
                        <span class="text-[14px] font-bold text-white shadow-sm">${p.name} ${p.id ? `(#${p.id})` : ''} - ${hpPercent}HP ${extra}</span>
                    </div>
                    <div class="flex justify-between text-[11px] text-white/90 font-bold border-t border-white/10 pt-1 relative z-10">
                        <span>${p.kills}/${p.deaths} - ${p.weapon}</span>
                    </div>
                    <div class="flex justify-between text-[10px] tracking-tighter relative z-10">
                        <span class="text-yellow-400 font-bold">$${p.money}</span>
                        <div class="flex items-center gap-1">
                            <!-- æ˜¾ç¤ºé“å…· -->
                            <span>${'â˜'.repeat(p.utility.smoke)}</span>
                            <span>${'ğŸ”¥'.repeat(p.utility.fire)}</span>
                            <span>${'ğŸ’£'.repeat(p.utility.nade)}</span>
                            <span>${'ğŸ§¨'.repeat(p.utility.flash)}</span>
                            <!-- æ˜¾ç¤ºæŠ¤ç”² -->
                            <span class="text-white font-bold uppercase ml-2">${p.armorType}</span>
                        </div>
                    </div>
                `;
                (p.team === 'T' ? tH : ctH).appendChild(card);
            });
            
            // è®¡æ—¶å™¨å’Œæ¯”åˆ†éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜
            const timerEl = document.getElementById('timer');
            if (state.bomb.state === 'planted') timerEl.innerText = `${state.bomb.time.toFixed(1)}s`;
            else timerEl.innerText = `${Math.floor(state.time/60)}:${Math.floor(state.time%60).toString().padStart(2,'0')}`;
            document.getElementById('score-t').innerText = state.score.t;
            document.getElementById('score-ct').innerText = state.score.ct;
        }

        function handleNadeThrows(dt) {
            if (state.isRoundEnded) return;
            state.lastNadeTime += dt * state.speed;
            if (state.lastNadeTime >= 20.0) {
                state.lastNadeTime = 0;
                
                // Tæ–¹æ‰‹é›·æŠ•æ·
                const tAlive = state.players.filter(p => p.isAlive && p.team === 'T');
                // æ‰¾åˆ°Tæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                const tLeaders = tAlive.filter(p => p.role === 'Rifle');
                const tNadePlayers = tAlive.filter(p => p.utility.nade > 0);
                
                if (tLeaders.length > 0 && tNadePlayers.length > 0) {
                    const tLeader = tLeaders[0];
                    // é€‰æ‹©1~2ä¸ªæœ‰æ‰‹é›·çš„äºº
                    const count = Math.min(2, tNadePlayers.length);
                    const selectedPlayers = tNadePlayers.sort(() => 0.5 - Math.random()).slice(0, count);
                    // Tæ–¹æŠ•æ·åœ°ç‚¹ï¼šaå°ä¸‹ã€aé—¨å¤–å’Œbç‚¹
                    const tTargets = ['aå°ä¸‹', 'aé—¨å¤–', 'bç‚¹'];
                    
                    selectedPlayers.forEach((player, index) => {
                        // éšæœºé€‰æ‹©ä¸€ä¸ªåœ°ç‚¹
                        const target = tTargets[Math.floor(Math.random() * tTargets.length)];
                        // è·å–ç›®æ ‡ç‚¹ä½åæ ‡
                        const targetNode = MAP_NODES[target];
                        
                        // æ£€æŸ¥ç›®æ ‡ç‚¹ä½æ˜¯å¦æœ‰é˜Ÿå‹
                        const hasTeammate = state.players.some(p => 
                            p.isAlive && p.team === player.team && 
                            Math.sqrt((p.x - targetNode.x)**2 + (p.y - targetNode.y)**2) < 50
                        );
                        
                        if (!hasTeammate) {
                            // æŠ•æ·æ‰‹é›·
                            player.utility.nade--;
                            state.grenades.push(new Grenade(player.team, player, player.x, player.y, targetNode.x, targetNode.y));
                            player.broadcastRadio(`æŠ•æ·æ‰‹é›·è‡³ ${target}ï¼`);
                            tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${player.name} å‘ ${target} æŠ•æ·æ‰‹é›·ï¼`);
                        } else {
                            tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${target} æœ‰é˜Ÿå‹ï¼Œå–æ¶ˆæ‰‹é›·æŠ•æ·ï¼`);
                        }
                    });
                }
                
                // CTæ–¹æ‰‹é›·æŠ•æ·
                const ctAlive = state.players.filter(p => p.isAlive && p.team === 'CT');
                // æ‰¾åˆ°CTæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                const ctLeaders = ctAlive.filter(p => p.role === 'Rifle');
                const ctNadePlayers = ctAlive.filter(p => p.utility.nade > 0);
                
                if (ctLeaders.length > 0 && ctNadePlayers.length > 0) {
                    const ctLeader = ctLeaders[0];
                    // é€‰æ‹©1~2ä¸ªæœ‰æ‰‹é›·çš„äºº
                    const count = Math.min(2, ctNadePlayers.length);
                    const selectedPlayers = ctNadePlayers.sort(() => 0.5 - Math.random()).slice(0, count);
                    // CTæ–¹æŠ•æ·åœ°ç‚¹ï¼šb1ã€ä¸­è¿œã€aé—¨
                    const ctTargets = ['b1', 'ä¸­è¿œ', 'aé—¨'];
                    
                    selectedPlayers.forEach((player, index) => {
                        // éšæœºé€‰æ‹©ä¸€ä¸ªåœ°ç‚¹
                        const target = ctTargets[Math.floor(Math.random() * ctTargets.length)];
                        // è·å–ç›®æ ‡ç‚¹ä½åæ ‡
                        const targetNode = MAP_NODES[target];
                        
                        // æ£€æŸ¥ç›®æ ‡ç‚¹ä½æ˜¯å¦æœ‰é˜Ÿå‹
                        const hasTeammate = state.players.some(p => 
                            p.isAlive && p.team === player.team && 
                            Math.sqrt((p.x - targetNode.x)**2 + (p.y - targetNode.y)**2) < 50
                        );
                        
                        if (!hasTeammate) {
                            // æŠ•æ·æ‰‹é›·
                            player.utility.nade--;
                            state.grenades.push(new Grenade(player.team, player, player.x, player.y, targetNode.x, targetNode.y));
                            player.broadcastRadio(`æŠ•æ·æ‰‹é›·è‡³ ${target}ï¼`);
                            ctLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${player.name} å‘ ${target} æŠ•æ·æ‰‹é›·ï¼`);
                        } else {
                            ctLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${target} æœ‰é˜Ÿå‹ï¼Œå–æ¶ˆæ‰‹é›·æŠ•æ·ï¼`);
                        }
                    });
                }
            }
        }

        function loop(now) {
            const dt = (now - state.lastTick) / 1000;
            state.lastTick = now;
            if (state.running && dt < 0.5) {
                if (!state.isRoundEnded) {
                    if (state.bomb.state === 'planted') {
                        state.bomb.time -= dt * state.speed;
                        if (state.bomb.time <= 0) {
                            // c4çˆ†ç‚¸éŸ³æ•ˆ
                            WeaponSounds.play('c4_explode');
                            
                            // c4çˆ†ç‚¸ä¼¤å®³ï¼š150-è·ç¦»ï¼ˆå¦‚æœæ˜¯æ­£æ•°ï¼‰
                            state.players.forEach(p => {
                                if (p.isAlive) {
                                    const dist = Math.sqrt((p.x - state.bomb.x)**2 + (p.y - state.bomb.y)**2);
                                    const damage = Math.max(0, 150 - dist);
                                    if (damage > 0) {
                                        p.hp -= damage;
                                        p.hitFlash = 1.0;
                                        
                                        if (p.hp <= 0) {
                                            p.hp = 0;
                                            p.isAlive = false;
                                            p.deaths++;
                                            
                                            if (WEAPONS[p.weapon].isMain) {
                                                state.droppedWeapons.push(new DroppedWeapon(p.weapon, p.x, p.y));
                                            }
                                            
                                            if (p.isPlanting) {
                                                state.bomb.state = 'idle';
                                                state.bomb.carrier = null;
                                                state.bomb.x = p.x;
                                                state.bomb.y = p.y;
                                                state.bomb.node = p.posNode;
                                                p.hasBomb = false;
                                            }
                                            if (p.hasBomb) {
                                                state.bomb.carrier = null;
                                                state.bomb.x = p.x;
                                                state.bomb.y = p.y;
                                                state.bomb.node = p.posNode;
                                                p.hasBomb = false;
                                            }
                                            if (state.bomb.defuser === p) {
                                                state.bomb.defuser = null;
                                                state.bomb.defuseProgress = 0;
                                                document.getElementById('defuse-bar-bg').classList.add('hidden');
                                            }
                                            
                                            addKillFeed({ name: 'ğŸ’£', team: 'T' }, p, 'ğŸ’£', false);
                                            checkRoundEnd();
                                        }
                                    }
                                }
                            });
                            
                            endRound('T', 'BOMB EXPLODED');
                        }
                        
                        // c4è¿˜æœ‰10ç§’å€’è®¡æ—¶ä¸”è§†é‡é‡Œæ²¡æœ‰æ•Œäººæ—¶çš„é€ƒè·‘é€»è¾‘
                        if (state.bomb.time <= 10 && state.bomb.time > 9.5) {
                            state.players.forEach(p => {
                                if (p.isAlive && p.team === 'CT' && p !== state.bomb.defuser) {
                                    // æ£€æŸ¥è§†é‡é‡Œæ˜¯å¦æœ‰æ•Œäºº
                                    const visibleEnemies = state.players.filter(e => 
                                        e.isAlive && e.team !== p.team && p.canSee(e)
                                    );
                                    
                                    if (visibleEnemies.length === 0) {
                                        let escapeTargets = [];
                                        if (state.bomb.node === 'aç‚¹') {
                                            // aåŒ…ï¼šæœä¸­è·¯ã€aé—¨å¤–ã€bç‚¹ä¸­çš„éšæœºä¸€ä¸ªåœ°æ–¹é€ƒè·‘
                                            escapeTargets = ['ä¸­è·¯', 'aé—¨å¤–', 'bç‚¹'];
                                        } else if (state.bomb.node === 'bç‚¹') {
                                            // båŒ…ï¼šæœè­¦å®¶ã€åèŠ±å›­ä¸­çš„éšæœºä¸€ä¸ªé€ƒè·‘
                                            escapeTargets = ['è­¦å®¶', 'åèŠ±å›­'];
                                        }
                                        
                                        if (escapeTargets.length > 0) {
                                            const target = escapeTargets[Math.floor(Math.random() * escapeTargets.length)];
                                            p.destination = target;
                                            p.path = findPath(p.posNode, target);
                                            p.pathIdx = 1;
                                            p.broadcastRadio(`C4å³å°†çˆ†ç‚¸ï¼Œé€ƒå¾€ ${target}ï¼`);
                                        }
                                    }
                                }
                            });
                        }
                        
                        // ç‚¸å¼¹æ»´å£°é€»è¾‘
                        if (state.bomb.lastBeep !== undefined) {
                            state.bomb.lastBeep += dt * state.speed;
                            
                            // æ ¹æ®å‰©ä½™æ—¶é—´è°ƒæ•´æ»´å£°é—´éš”
                            if (state.bomb.time > 20) {
                                state.bomb.beepInterval = 800; // å‰20ç§’ï¼š0.8ç§’
                            } else if (state.bomb.time > 10) {
                                state.bomb.beepInterval = 600; // 20-30ç§’ï¼š0.6ç§’
                            } else if (state.bomb.time > 5) {
                                state.bomb.beepInterval = 400; // 30-35ç§’ï¼š0.4ç§’
                            } else {
                                state.bomb.beepInterval = 200; // 35-40ç§’ï¼š0.2ç§’
                            }
                            
                            // æ’­æ”¾æ»´å£°
                            if (state.bomb.lastBeep >= state.bomb.beepInterval / 1000) {
                                WeaponSounds.play('c4_beep');
                                state.bomb.lastBeep = 0;
                            }
                        }
                    } else {
                        state.time -= dt * state.speed;
                        if (state.time <= 0) endRound('CT', 'TIME EXPIRED');
                        
                        // CTå¼€å±€åç¬¬10ç§’ï¼ŒæŒ‡æŒ¥å‘½ä»¤ä¸€ä¸ªæœ‰ç«çš„äººä¸¢b2ç«
                        if (state.time >= 104 && state.time <= 105 && !state.hasReleasedCTB2Fire) {
                            // æ‰¾åˆ°CTæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                            const ctPlayers = state.players.filter(p => p.team === 'CT');
                            const ctCommanders = ctPlayers.filter(p => p.role === 'Rifle');
                            const ctLeader = ctCommanders.length > 0 ? ctCommanders[0] : ctPlayers[0];
                            const ctPlayersWithFire = state.players.filter(p => 
                                p.team === 'CT' && p.isAlive && p.utility.fire > 0
                            );
                            
                            if (ctLeader && ctPlayersWithFire.length > 0) {
                                const firePlayer = ctPlayersWithFire[Math.floor(Math.random() * ctPlayersWithFire.length)];
                                ctLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${firePlayer.name} å‘ b2 ä¸¢ç‡ƒçƒ§ç“¶ï¼`);
                                firePlayer.utility.fire--;
                                state.molotovs.push(new Molotov(firePlayer.team, firePlayer, firePlayer.x, firePlayer.y, 'b2'));
                                firePlayer.broadcastRadio(`æ”¶åˆ°ï¼Œå‘ b2 ä¸¢ç‡ƒçƒ§ç“¶ï¼`);
                                state.hasReleasedCTB2Fire = true;
                            }
                        }
                        
                        // Tæ–¹æŒ‡æŒ¥å¼€å±€50%æ¦‚ç‡æ´¾ä¸€åé€‰æ‰‹ä¸¢aå°ä¸Šé›·æˆ–è€…aå°ä¸‹é›·
                        if (state.time >= 110 && state.time <= 111 && !state.hasReleasedStartNade) {
                            if (Math.random() < 0.5) { // 50%æ¦‚ç‡
                                // æ‰¾åˆ°Tæ–¹çš„æŒ‡æŒ¥ï¼ˆå–ç¬¬ä¸€ä¸ªRifleè§’è‰²çš„é€‰æ‰‹ä½œä¸ºæŒ‡æŒ¥ï¼‰
                                const tPlayers = state.players.filter(p => p.team === 'T');
                                const tCommanders = tPlayers.filter(p => p.role === 'Rifle');
                                const tLeader = tCommanders.length > 0 ? tCommanders[0] : tPlayers[0];
                                const tPlayersWithNade = state.players.filter(p => 
                                    p.team === 'T' && p.isAlive && p.utility.nade > 0
                                );
                                
                                if (tLeader && tPlayersWithNade.length > 0) {
                                    const nadePlayer = tPlayersWithNade[Math.floor(Math.random() * tPlayersWithNade.length)];
                                    // éšæœºé€‰æ‹©aå°ä¸Šæˆ–aå°ä¸‹
                                    const targetNode = Math.random() > 0.5 ? 'aå°ä¸Š' : 'aå°ä¸‹';
                                    tLeader.broadcastRadio(`æŒ‡æŒ¥ï¼š${nadePlayer.name} å‘ ${targetNode} ä¸¢æ‰‹é›·ï¼`);
                                    nadePlayer.utility.nade--;
                                    const target = MAP_NODES[targetNode];
                                    state.grenades.push(new Grenade(nadePlayer.team, nadePlayer, nadePlayer.x, nadePlayer.y, target.x, target.y));
                                    nadePlayer.broadcastRadio(`æ”¶åˆ°ï¼Œå‘ ${targetNode} ä¸¢æ‰‹é›·ï¼`);
                                }
                            }
                            state.hasReleasedStartNade = true;
                        }
                    }
                    handleTacticalSmokes(dt);
                    handleMolotovThrows(dt);
                    handleNadeThrows(dt);
                    checkReorganizeTactics(dt);
                }
                state.smokes.forEach((s, i) => { s.update(dt * state.speed); if (s.life <= 0) state.smokes.splice(i, 1); });
                state.flashes.forEach((f, i) => { f.update(dt * state.speed); if (f.exploded && f.flashLife <= 0) state.flashes.splice(i, 1); });
                if (state.molotovs) {
                    state.molotovs.forEach((m, i) => { m.update(dt * state.speed); if (m.exploded && m.life <= 0) state.molotovs.splice(i, 1); });
                }
                if (state.grenades) {
                    state.grenades.forEach((g, i) => { g.update(dt * state.speed); if (g.exploded && g.explosionTime >= 1) state.grenades.splice(i, 1); });
                }
                
                // æ›´æ–°å¼€ç«ç‰¹æ•ˆ
                if (state.fireEffects) {
                    state.fireEffects = state.fireEffects.filter(effect => {
                        effect.life -= dt * state.speed;
                        return effect.life > 0;
                    });
                }
                
                state.players.forEach(p => p.update(dt, now));
                updateHUD();
            }
            draw();
            requestAnimationFrame(loop);
        }

        document.getElementById('btn-start').addEventListener('click', () => { if (state.players.length === 0) initRound(); state.running = !state.running; state.lastTick = performance.now(); document.getElementById('btn-start').innerText = state.running ? "æš‚åœæ¨¡æ‹Ÿ" : "æ¢å¤æ¨¡æ‹Ÿ"; });
        document.getElementById('btn-speed').addEventListener('click', () => { state.speed = state.speed >= 4 ? 1 : state.speed * 2; document.getElementById('btn-speed').innerText = `é€Ÿåº¦: ${state.speed}x`; });
        initRound(); requestAnimationFrame(loop);
    </script>
</body>

</html>
